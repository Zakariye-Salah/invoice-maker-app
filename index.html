<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supermarket Auth & Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-KtH6cL3sV+2F/..." crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="style.css">
<style>
  /* Smooth modal show/hide */
  .modal-enter { opacity: 0; transform: translateY(-10px) scale(0.98); }
  .modal-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: all 220ms cubic-bezier(.2,.8,.2,1); }
  .modal-exit { opacity: 1; transform: translateY(0) scale(1); }
  .modal-exit-active { opacity: 0; transform: translateY(-8px) scale(0.98); transition: all 180ms ease; }

  /* small utilities */
  .action-icon { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; background:transparent; border:none; cursor:pointer; transition:transform .12s; }
  .action-icon:hover { transform:translateY(-2px); background: rgba(15,23,42,0.04); }
  .action-btn { display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:none; cursor:pointer; }
  .no-print { -webkit-print-color-adjust: exact; }
  @media print {
    .no-print, footer, .navBtn { display:none !important; }
  }

  /* ensure auth controls are above footer/nav */
  #authSection { z-index: 40; position: relative; }
  .storeSettingsBtn { display:inline-flex; gap:6px; align-items:center; padding:6px; border-radius:8px; cursor:pointer; }

  /* ===== Reports Table Mobile Styling ===== */

/* Hide table header on small screens */
@media (max-width: 640px) {
  #reportsTableHead {
    display: none !important;
  }

  /* Prevent horizontal scrollbars */
  #reportsTableWrapper {
    overflow-x: hidden !important;
  }

  /* Ensure table rows display as blocks/cards */
  #reportsTable tr td {
    display: block;
    width: 100%;
  }

  /* Add spacing between mobile report cards */
  #reportsTable tr {
    margin-bottom: 1rem;
    display: block;
    border: none;
  }
}
/* Hide reports table header and scrollbars on small screens for safety.
   JS will also toggle .hidden on thead for extra safety.
*/
@media (max-width: 640px) {
  /* hide the header row visually but keep table semantics */
  #reportsReportContent table thead,
  #reportsReportContent table thead tr,
  #reportsReportContent table thead th {
    display: none !important;
    visibility: collapse !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
  }

  /* hide horizontal scrollbar on small screens */
  #reportsReportContent .overflow-x-auto {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;     /* Firefox */
  }
  #reportsReportContent .overflow-x-auto::-webkit-scrollbar {
    display: none;             /* Safari and Chrome */
  }
}

/* Simple toast style helper */
#app-toast {
  transition: opacity 0.35s ease, transform 0.35s ease;
  transform-origin: right bottom;
  opacity: 1;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}
#app-toast.opacity-0 { opacity: 0; transform: translateY(6px); }

</style>
</head>
<body class="bg-gray-100">

<!-- ================= AUTH SECTION ================= -->
<div id="authSection" class="max-w-lg mx-auto p-6 bg-white shadow-md mt-10 rounded-lg">
  <!-- Registration -->
  <div id="registrationForm">
    <h1 class="text-2xl font-bold mb-4">Supermarket Registration</h1>
    <input id="regName" placeholder="Supermarket Name" class="w-full p-2 mb-2 border rounded">
    <input id="regAddress" placeholder="Address" class="w-full p-2 mb-2 border rounded">
    <input id="regPhone" placeholder="Phone" class="w-full p-2 mb-2 border rounded">
    <input id="regEmail" placeholder="Email" class="w-full p-2 mb-2 border rounded">
    <input id="regPassword" type="password" placeholder="Password" class="w-full p-2 mb-2 border rounded">
    <input id="regConfirm" type="password" placeholder="Confirm Password" class="w-full p-2 mb-4 border rounded">
    <button id="registerBtn" class="w-full bg-blue-600 text-white p-2 rounded mb-6 hover:bg-blue-700">Register</button>
    <p class="text-center text-sm">Already have an account?
      <button id="showLogin" type="button" class="text-blue-600 underline ml-1">Login here</button>
    </p>
  </div>

  <!-- Login -->
  <div id="loginForm" class="hidden">
    <h1 class="text-2xl font-bold mb-4">Supermarket Login</h1>
    <input id="loginName" placeholder="Supermarket Name" class="w-full p-2 mb-2 border rounded">
    <input id="loginPassword" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
    <button id="loginBtn" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Login</button>
    <p class="text-center text-sm">Don't have an account?
      <button id="showRegister" type="button" class="text-blue-600 underline ml-1">Register here</button>
    </p>
  </div>
</div>

<!-- ================= DASHBOARD SECTION ================= -->
<div id="dashboardSection" class="hidden max-w-6xl mx-auto p-6 bg-white shadow-md mt-10 rounded-lg">

  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold">Dashboard - <span id="storeDisplayDesktop"></span></h1>
      <!-- settings placeholder (JS will show/hide .storeSettingsBtn) -->
       <!-- Optional: hidden settings cog placed next to store name (will be unhidden after login by JS) -->
<button id="storeSettingsBtn" class="storeSettingsBtn hidden inline-flex items-center gap-2 ml-2 px-2 py-1 rounded bg-emerald-600 text-white" title="Settings" aria-label="Open settings">
  <i class="fa-solid fa-cog"></i>
</button>
      </button>
    </div>
    <button id="logoutBtn" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Logout</button>
  </div>

  <!-- ================= DASHBOARD CONTENT ================= -->
  <div id="dashboardContent" class="mt-6">
    <h2 class="text-xl font-bold mb-4">Reports Summary</h2>

    <!-- Responsive Card Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Invoices Card -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-xl transition">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Total Invoices</h3>
        <p id="totalInvoices" class="text-3xl font-bold text-blue-600 mt-2">0</p>
      </div>

      <!-- Products Card -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-xl transition">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Total Products</h3>
        <p id="totalProducts" class="text-3xl font-bold text-green-600 mt-2">0</p>
      </div>

      <!-- Sales Card -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 flex flex-col items-center justify-center hover:shadow-xl transition">
        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Total Sales</h3>
        <p id="totalSales" class="text-3xl font-bold text-purple-600 mt-2">0</p>
      </div>

    </div>
  </div>

  <!-- ================= INVOICES SECTION ================= -->
  <div id="invoicesSection" class="hidden max-w-5xl mx-auto p-4 sm:p-6">

    <!-- CREATE INVOICE BUTTON -->
    <div class="mb-4 flex items-center justify-between flex-wrap gap-2">
      <button id="createInvoiceBtn"
              class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 shadow transition-all duration-200 flex items-center gap-2">
        + Create Invoice
      </button>
      <span id="currentTime" class="text-sm text-red-500 font-semibold"></span>
    </div>

    <!-- CREATE INVOICE FORM -->
    <section id="createInvoiceSection" class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6 hidden-section">
      <input type="hidden" id="editingInvoiceId" />
      <h2 class="text-lg font-semibold mb-3">Create Invoice</h2>

      <!-- Customer Info -->
      <div class="grid sm:grid-cols-5 gap-3 mb-4">
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Name</span>
          <input id="customerName" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. Zakariye Salah" />
        </label>
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Phone</span>
          <input id="customerPhone" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. 617125558" />
        </label>
        <label class="block">
          <span class="text-sm">Invoice Date</span>
          <input id="invoiceDate" type="date" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </label>
      </div>

      <!-- Invoice Items -->
      <div id="invoiceItemsContainer" class="mb-3"></div>
      <button id="addItemBtn" class="mb-3 inline-block rounded-xl bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">+ Add Item</button>

      <div class="grid sm:grid-cols-3 gap-3 mb-3">
        <label>
          <span class="text-sm">Total Amount</span>
          <input id="amount" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" readonly />
        </label>
        <label>
          <span class="text-sm">Amount Paid</span>
          <input id="paid" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" />
        </label>
        <label>
          <span class="text-sm">Status</span>
          <select id="status" class="mt-1 w-full rounded-xl border px-3 py-2">
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
        </label>
      </div>

      <button id="saveInvoiceBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 w-full">Save Invoice</button>
      <p id="formMsg" class="hidden mt-3 text-red-600 text-sm"></p>
    </section>

    <!-- INVOICES LIST -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <h2 id="invoicesTitle" class="text-lg font-semibold mr-3">Invoices</h2>

        <div class="flex flex-wrap items-center gap-2 flex-1 min-w-[250px]">
          <button id="clearPaidBtn" class="bg-red-600 text-white px-3 py-2 rounded whitespace-nowrap">Clear Paid</button>
          <select id="filterStatus" class="rounded-xl border px-3 py-2 whitespace-nowrap">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
          <input id="searchName" class="rounded-xl border px-3 py-2 flex-1 min-w-[120px]" placeholder="Search by name..." />
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 mb-4">
        <select id="reminderMethod" class="border rounded px-2 py-1 whitespace-nowrap">
          <option value="wa">WhatsApp</option>
          <option value="sms">SMS</option>
        </select>
        <button id="sendAllReminders" class="bg-purple-600 text-white px-3 py-2 rounded whitespace-nowrap">Send All Reminders</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead class="hidden sm:table-header-group">
            <tr>
              <th class="p-2 font-medium text-blue-600">No</th>
              <th class="p-2 font-medium text-blue-600">Invoice</th>
              <th class="p-2 font-medium text-blue-600">Date</th>
              <th class="p-2 font-medium text-blue-600">Customer</th>
              <th class="p-2 font-medium text-blue-600">Phone</th>
              <th class="p-2 font-medium text-blue-600 text-right">Amount</th>
              <th class="p-2 font-medium text-blue-600 text-right">Paid</th>
              <th class="p-2 font-medium text-blue-600 text-right">Balance</th>
              <th class="p-2 font-medium text-blue-600">Status</th>
              <th class="p-2 font-medium text-blue-600 no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="invoiceRows" class="block sm:table-row-group"></tbody>
        </table>
      </div>

      <p id="emptyState" class="hidden text-center text-gray-500 py-6">No invoices yet.</p>
    </section>
  </div>

  <!-- ================= PRODUCTS SECTION ================= -->
  <div id="productsSection" class="hidden mb-8">
    <!-- Page container -->
    <div class="min-h-screen flex flex-col pb-24">

      <!-- Top bar -->
      <header class="bg-white/90 dark:bg-gray-800/90 backdrop-blur border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-boxes-stacked text-xl text-blue-600"></i>
            <h1 id="pageTitle" class="text-lg font-semibold">Products</h1>
          </div>

          <!-- Right: search + add -->
          <div class="flex items-center gap-2 w-full max-w-md">
            <div class="relative flex-1">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input
                id="searchInput"
                type="search"
                class="w-full pl-9 pr-3 py-2 rounded-xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Search products..."
              />
            </div>
            <button id="addProductBtn"
              class="whitespace-nowrap bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow transition flex items-center gap-2">
              <i class="fa-solid fa-plus"></i>
            </button>

            <!-- Shop/Cart button -->
            <button id="openCartHeader"
              class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl shadow transition flex items-center gap-1">
              <i class="fa-solid fa-cart-shopping"></i>
              <span id="cartCountHeader" class="ml-1">0</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Shop Modal -->
      <div id="shopModal" class="hidden fixed inset-0 z-50">
        <div id="shopBackdrop" class="absolute inset-0 bg-black/40"></div>
        <div class="relative max-w-lg mx-auto mt-20 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-5">
          <h3 class="text-lg font-semibold mb-3">Shopping Cart</h3>
          <div id="cartItems" class="space-y-3 max-h-60 overflow-y-auto"></div>
          <div class="flex justify-between mt-4">
            <button id="clearCart" class="px-4 py-2 rounded-lg bg-red-500 text-white">Cancel All</button>
            <button id="closeCart" class="px-4 py-2 rounded-lg bg-gray-300">Cancel</button>
            <button id="sellCart" class="px-4 py-2 rounded-lg bg-green-600 text-white">Sell</button>
          </div>
        </div>
      </div>

      <!-- Invoice Modal -->
      <div id="invoiceModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative max-w-lg mx-auto mt-20 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-5">
          <h3 class="text-lg font-semibold mb-3">Invoice</h3>
          <form id="invoiceForm" class="space-y-3">
            <input type="text" id="customerName" placeholder="Customer name" class="w-full border p-2 rounded" required>
            <input type="tel" id="customerPhone" value="+252" class="w-full border p-2 rounded" required>
            <input type="date" id="invoiceDate" class="w-full border p-2 rounded" required>
            <div>Total: <span id="invoiceTotal">$0.00</span></div>
            <input type="number" id="amountPaid" placeholder="Amount paid" class="w-full border p-2 rounded">
            <select id="status" class="w-full border p-2 rounded">
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
            <div class="flex justify-between mt-4">
              <button type="button" id="backToCart" class="px-4 py-2 bg-gray-300 rounded">Back</button>
              <button type="button" id="buyRecord" class="px-4 py-2 bg-blue-600 text-white rounded">Buy & Record Invoice</button>
              <button type="button" id="buyOnly" class="px-4 py-2 bg-green-600 text-white rounded">Buy Only</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Content -->
      <main class="max-w-6xl mx-auto w-full px-4 pt-4 flex-1">

        <!-- Empty state -->
        <div id="emptyState" class="hidden text-center py-16">
          <div class="text-5xl mb-4">üóÉÔ∏è</div>
          <p id="emptyTitle" class="text-lg font-semibold mb-1">No products yet</p>
          <p id="emptyDesc" class="text-gray-500 mb-4">Click ‚ÄúAdd Product‚Äù to create your first one.</p>
          <button id="emptyAddBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl shadow transition">
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>

        <!-- Product table (desktop) -->
        <div class="hidden md:block">
          <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow">
            <table class="min-w-full">
              <thead>
                <tr class="text-left text-sm uppercase tracking-wide text-gray-600 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700">
                  <th class="px-4 py-3">#</th>
                  <th class="px-4 py-3" id="thName">Product</th>
                  <th class="px-4 py-3" id="thCost">Original Price</th>
                  <th class="px-4 py-3" id="thPrice">Price</th>
                  <th class="px-4 py-3" id="thQty">Qty</th>
                  <th class="px-4 py-3" id="thActions">Actions</th>
                </tr>
              </thead>
              <tbody id="productRows"></tbody>
            </table>
          </div>
        </div>

        <!-- Product cards (mobile) -->
        <div id="productCards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mt-4"></div>
      </main>

      <!-- Add some padding at the bottom so content isn't hidden -->
      <div class="pb-16"></div>

    </div>

    <!-- Add Product Modal -->
    <div id="productModal" class="hidden fixed inset-0 z-50">
      <div id="productModalBackdrop" class="absolute inset-0 bg-black/40"></div>
      <div id="productDialog"
           class="relative max-w-md w-[92%] sm:w-[420px] mx-auto mt-20 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 id="modalTitle" class="text-lg font-semibold"></h3>
          <button id="closeModal" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <form id="productForm" class="space-y-3">
          <label class="block">
            <span id="lblName" class="text-sm text-gray-600 dark:text-gray-300">Product Name *</span>
            <input id="productName" class="mt-1 w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Rice 25kg" required />
          </label>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <label class="block">
              <span id="lblCost" class="text-sm text-gray-600 dark:text-gray-300">Original Price</span>
              <input id="productCost" type="number" step="0.01" min="0"
                     class="mt-1 w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" />
            </label>
            <label class="block">
              <span id="lblPrice" class="text-sm text-gray-600 dark:text-gray-300">Price *</span>
              <input id="productPrice" type="number" step="0.01" min="0"
                     class="mt-1 w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" required />
            </label>
            <label class="block">
              <span id="lblQty" class="text-sm text-gray-600 dark:text-gray-300">Quantity *</span>
              <input id="productQty" type="number" step="1" min="0"
                     class="mt-1 w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" required />
            </label>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button type="button" id="cancelModal"
                    class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
              Cancel
            </button>
            <button type="submit" id="saveProductBtn"
                    class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white">
              Save Product
            </button>
          </div>
        </form>
      </div>
    </div>

  </div> <!-- end productsSection -->

  <!-- ================= REPORTS SECTION ================= -->
  <div id="reportsSection" class="hidden">
    <div class="max-w-6xl mx-auto p-6">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">Reports</h1>
          <p class="text-sm text-gray-600">Centralized sales records ‚Äî live & exportable</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="reportsExportPdf" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            <i class="fa-solid fa-file-pdf"></i> Export PDF
          </button>
          <button id="reportsDeleteAll" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            <i class="fa-solid fa-trash"></i> Delete All
          </button>
        </div>
      </header>

      <!-- controls -->
      <div class="bg-white p-4 rounded-lg shadow mb-4">
        <div class="flex flex-wrap gap-3 items-center">
          <label class="flex items-center gap-2">
            <span class="text-sm font-medium">Filter:</span>
            <select id="reportsPeriod" class="border rounded px-3 py-2">
              <option value="lifetime">All time</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly (7 days)</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </label>

          <label class="flex items-center gap-2">
            <span class="text-sm font-medium">Date:</span>
            <input id="reportsDate" type="date" class="border rounded px-3 py-2" />
          </label>

          <label class="flex items-center gap-2">
            <span class="text-sm font-medium">Search:</span>
            <input id="reportsSearchInput" type="search" placeholder="Product or customer..." class="border rounded px-3 py-2" />
          </label>

          <div class="ml-auto flex items-center gap-4">
            <div class="text-sm">
              <div>Total Items: <span id="reportsTotalItems" class="font-semibold">0</span></div>
              <div>Total Sales: <span id="reportsTotalSales" class="font-semibold">0.00</span></div>
            </div>
          </div>
        </div>
      </div>

   <!-- report content (export target) -->
<div id="reportsReportContent" class="bg-white rounded-lg shadow p-4">

  <!-- Table wrapper for desktop -->
  <div id="reportsTableWrapper" class="overflow-x-auto">
    <table class="w-full table-auto" id="reportsTable">
      <thead id="reportsTableHead">
        <tr class="text-left text-sm text-gray-600 border-b">
          <th class="p-2">#</th>
          <th class="p-2">Products</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Total</th>
          <th class="p-2">Paid</th>
          <th class="p-2">Due</th>
          <th class="p-2">Status</th>
          <th class="p-2">Customer</th>
          <th class="p-2">Phone</th>
          <th class="p-2">Timestamp</th>
          <th class="p-2 no-print">Actions</th>
        </tr>
      </thead>
      <tbody id="reportsRows"></tbody>
    </table>
  </div>

  <!-- Empty message -->
  <p id="reportsEmptyMsg" class="text-center text-gray-500 mt-4 hidden">
    No reports to show.
  </p>
</div>


    <!-- confirm delete all modal (simple) -->
    <div id="reportsConfirmDeleteAll" class="hidden fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="bg-white p-6 rounded shadow z-10 w-96">
        <h3 class="text-lg font-semibold mb-3">Delete all reports?</h3>
        <p class="mb-4">This will permanently remove all report records for this store.</p>
        <div class="flex justify-end gap-2">
          <button id="reportsCancelDeleteAll" class="px-3 py-2 rounded bg-gray-200">Cancel</button>
          <button id="reportsConfirmDeleteAllBtn" class="px-3 py-2 rounded bg-red-600 text-white">Delete All</button>
        </div>
      </div>
    </div>
  </div>
</div> <!-- end dashboardSection -->

<!-- ================= BOTTOM NAVIGATION ================= -->
<div class="flex justify-around mb-4 max-w-6xl mx-auto">
  <button class="navBtn bg-gray-200 p-2 rounded" data-target="dashboardContent">Dashboard</button>
  <button class="navBtn bg-gray-200 p-2 rounded" data-target="invoicesSection">Invoices</button>
  <button class="navBtn bg-gray-200 p-2 rounded" data-target="productsSection">Products</button>
  <button class="navBtn bg-gray-200 p-2 rounded" data-target="reportsSection">Reports</button>
</div>

<!-- ================= FOOTER ================= -->
<footer class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 px-6 py-6 mt-8 border-t border-gray-300 dark:border-gray-700">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
    <div class="text-sm text-gray-600 dark:text-gray-400">
      &copy; 2025 <span class="font-semibold">Zakariye</span>. All rights reserved.
    </div>
    <div class="flex gap-4 items-center">
      <a href="mailto:engzaki410@gmail.com" target="_blank" class="hover:text-red-600 transition-colors" title="Email">
        <i class="fa-solid fa-envelope fa-lg"></i>
      </a>
      <a href="https://wa.me/252617125558" target="_blank" class="hover:text-green-500 transition-colors" title="WhatsApp">
        <i class="fa-brands fa-whatsapp fa-lg"></i>
      </a>
      <a href="https://www.facebook.com/share/19ayTrQCzP/" target="_blank" class="hover:text-blue-800 transition-colors" title="Facebook">
        <i class="fa-brands fa-facebook fa-lg"></i>
      </a>
      <a href="https://github.com/Zakariye-Salah/" target="_blank" class="hover:text-gray-900 dark:hover:text-white transition-colors" title="GitHub">
        <i class="fa-brands fa-github fa-lg"></i>
      </a>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script >
      /* auth.js - complete updated
   Features:
   - registration / login / logout
   - dashboard (responsive cards)
   - settings modal (green cog)
   - language switching (basic)
   - dark mode toggle (persist)
   - products: add/edit/delete, responsive table + cards, icon-only action buttons
   - cart & sell: open cart, sell (record invoice + reports) and buy-only
   - invoices: create/edit/toggle/delete/print/share/WA/SMS/call
   - reminders: per-invoice and grouped sendAllReminders with confirm modal
   - reports: filters (daily, weekly, monthly, yearly, lifetime), search, export PDF, delete
   - notifications: in-page toasts (replace alert)
   - minor accessibility and responsiveness improvements
*/

(function () {
  'use strict';

  /* =========================
     STORAGE KEYS & HELPERS
     ========================= */
  const LS_USERS = "supermarket_users_v2";
  const LS_CURRENT_USER = "currentSupermarket_v2";
  const LS_INVOICES = "invoices_v2";
  const LS_PRODUCTS = "products_v2";
  const LS_REPORTS = "reports_v2";
  const LS_MSG_TPL = "msg_templates_v2";
  const LS_NOTICES = "notices_v2";
  const LS_APP_LANG = "app_lang_v2";
  const LS_DARK = "app_dark_mode_v2";

  function lsGet(key, fallback = null) {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
  }
  function lsSet(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) { console.error("lsSet failed", e); }
  }
  function lsRemove(key) { try { localStorage.removeItem(key); } catch (e) {} }

  /* seed templates/notices if none */
  if (!lsGet(LS_MSG_TPL)) {
    lsSet(LS_MSG_TPL, {
      reminder_wa: "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}.\nFadlan iska bixi dukaanka {store} ({phone}).",
      reminder_sms: "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}. Fadlan iska bixi dukaanka {store} ({phone})."
    });
  }
  if (!lsGet(LS_NOTICES)) {
    lsSet(LS_NOTICES, [{ id: `N-${Date.now()}`, title: "Welcome", body: "Welcome to the supermarket invoicing app.", pinned: true, created: Date.now() }]);
  }

  /* small helpers */
  function fmtMoney(n) { const num = Number(n) || 0; return num.toFixed(2); }
  function fmtDate(d) { const date = d ? new Date(d) : new Date(); const yyyy = date.getFullYear(); const mm = String(date.getMonth() + 1).padStart(2, '0'); const dd = String(date.getDate()).padStart(2, '0'); return `${yyyy}-${mm}-${dd}`; }
  function fmtDateTime(ts) { const d = new Date(ts); if (isNaN(d)) return String(ts); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
  function escapeHtml(s) { if (s == null) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
  function cleanPhone(phone) { if (!phone) return ''; let p = String(phone).replace(/\D/g, ''); if (!p) return ''; if (p.startsWith('252')) return p; if (p.startsWith('0')) p = p.slice(1); if (!p.startsWith('252')) p = '252' + p; return p; }

  /* storage wrappers */
  function getUsers() { return lsGet(LS_USERS, []); }
  function saveUsers(u) { lsSet(LS_USERS, u); }
  function getCurrentUser() { return lsGet(LS_CURRENT_USER, null); }
  function setCurrentUser(u) { lsSet(LS_CURRENT_USER, u); }
  function clearCurrentUser() { lsRemove(LS_CURRENT_USER); }

  function getAllInvoices() { return lsGet(LS_INVOICES, []); }
  function saveAllInvoices(arr) { lsSet(LS_INVOICES, arr); }
  function getStoreInvoices(storeName) { if (!storeName) return []; return getAllInvoices().filter(i => String(i.store || '').toLowerCase() === String(storeName || '').toLowerCase()); }

  function getAllProducts() { return lsGet(LS_PRODUCTS, []); }
  function saveAllProducts(arr) { lsSet(LS_PRODUCTS, arr); }
  function getStoreProducts(storeName) { if (!storeName) return []; return getAllProducts().filter(p => String(p.store || '').toLowerCase() === String(storeName || '').toLowerCase()); }

  function getAllReports() { return lsGet(LS_REPORTS, []); }
  function saveAllReports(arr) { lsSet(LS_REPORTS, arr); }

  /* =========================
     NOTIFICATIONS / TOASTS (replace alert)
     ========================= */
  (function createToasts() {
    if (document.getElementById('appToasts')) return;
    const div = document.createElement('div');
    div.id = 'appToasts';
    div.style.position = 'fixed';
    div.style.right = '16px';
    div.style.top = '16px';
    div.style.zIndex = 9999;
    div.style.display = 'flex';
    div.style.flexDirection = 'column';
    div.style.gap = '8px';
    document.body.appendChild(div);
  })();
  function toast(msg, type = 'info', ms = 3000) {
    const wrap = document.getElementById('appToasts');
    if (!wrap) { alert(msg); return; }
    const el = document.createElement('div');
    el.className = 'shadow rounded p-3 text-sm max-w-xs';
    el.style.background = type === 'error' ? '#fee2e2' : (type === 'success' ? '#dcfce7' : '#e6f0ff');
    el.style.color = type === 'error' ? '#991b1b' : (type === 'success' ? '#065f46' : '#0f172a');
    el.style.border = '1px solid rgba(0,0,0,0.04)';
    el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(() => { el.style.transition = 'opacity 220ms'; el.style.opacity = '0'; setTimeout(() => el.remove(), 220); }, ms);
  }

  /* small polyfills for optional libs */
  function ensureLib(url, globalName) {
    return new Promise((res, rej) => {
      if (globalName && window[globalName]) return res(true);
      const s = document.createElement('script');
      s.src = url;
      s.onload = () => res(true);
      s.onerror = () => rej(new Error('Failed to load ' + url));
      document.head.appendChild(s);
    });
  }

  /* =========================
     TRANSLATION (minimal)
     ========================= */
  const I18N = {
    en: { dashboard: "Dashboard" },
    so: { dashboard: "Dashboard" }
  };
  function applyLanguage(lang) {
    if (!lang) lang = lsGet(LS_APP_LANG, 'en') || 'en';
    lsSet(LS_APP_LANG, lang);
    const storeEl = document.getElementById('storeDisplayDesktop');
    if (storeEl) {
      const name = storeEl.textContent || getCurrentUser()?.name || '';
      const base = (I18N[lang] && I18N[lang].dashboard) || 'Dashboard';
      const h = storeEl.closest && storeEl.closest('h1');
      if (h) h.textContent = `${base} - ${name}`;
    }
  }
  applyLanguage(lsGet(LS_APP_LANG, 'en'));

  /* =========================
     BASIC UI LOOKUPS
     ========================= */
  const authSection = document.getElementById("authSection");
  const dashboardSection = document.getElementById("dashboardSection");

  // auth
  const registrationForm = document.getElementById("registrationForm");
  const regName = document.getElementById("regName");
  const regAddress = document.getElementById("regAddress");
  const regPhone = document.getElementById("regPhone");
  const regEmail = document.getElementById("regEmail");
  const regPassword = document.getElementById("regPassword");
  const regConfirm = document.getElementById("regConfirm");
  const registerBtn = document.getElementById("registerBtn");

  const loginForm = document.getElementById("loginForm");
  const loginName = document.getElementById("loginName");
  const loginPassword = document.getElementById("loginPassword");
  const loginBtn = document.getElementById("loginBtn");

  const showLoginBtn = document.getElementById("showLogin");
  const showRegisterBtn = document.getElementById("showRegister");
  const logoutBtn = document.getElementById("logoutBtn");

  const storeDisplayDesktop = document.getElementById("storeDisplayDesktop");
  const totalInvoicesEl = document.getElementById("totalInvoices");
  const totalProductsEl = document.getElementById("totalProducts");
  const totalSalesEl = document.getElementById("totalSales");

  const navButtons = Array.from(document.querySelectorAll(".navBtn"));
  const dashboardContent = document.getElementById("dashboardContent");
  const invoicesSection = document.getElementById("invoicesSection");
  const productsSection = document.getElementById("productsSection");
  const reportsSection = document.getElementById("reportsSection");

  // invoices scope (some elements are in products/invoices area)
  const invArea = invoicesSection;
  const createInvoiceBtn = invArea?.querySelector('#createInvoiceBtn');
  const currentTimeEl = invArea?.querySelector('#currentTime');
  const createInvoiceSection = invArea?.querySelector('#createInvoiceSection');
  const editingInvoiceId = invArea?.querySelector('#editingInvoiceId');
  const customerNameInput = invArea?.querySelector('#customerName');
  const customerPhoneInput = invArea?.querySelector('#customerPhone');
  const invoiceDateInput = invArea?.querySelector('#invoiceDate');
  const invoiceItemsContainer = invArea?.querySelector('#invoiceItemsContainer');
  const addItemBtn = invArea?.querySelector('#addItemBtn');
  const amountInput = invArea?.querySelector('#amount');
  const paidInput = invArea?.querySelector('#paid');
  const statusSelect = invArea?.querySelector('#status');
  const saveInvoiceBtn = invArea?.querySelector('#saveInvoiceBtn');
  const formMsg = invArea?.querySelector('#formMsg');
  const invoiceRows = invArea?.querySelector('#invoiceRows');
  const emptyStateInv = invArea?.querySelector('#emptyState');
  const clearPaidBtn = invArea?.querySelector('#clearPaidBtn');
  const filterStatus = invArea?.querySelector('#filterStatus');
  const searchName = invArea?.querySelector('#searchName');
  const reminderMethod = invArea?.querySelector('#reminderMethod');
  const sendAllRemindersBtn = invArea?.querySelector('#sendAllReminders');

  // products scope
  const prodSection = productsSection;
  const addProductBtn = document.getElementById('addProductBtn');
  const productModal = document.getElementById('productModal');
  const productModalBackdrop = document.getElementById('productModalBackdrop');
  const closeModalBtn = document.getElementById('closeModal');
  const cancelModalBtn = document.getElementById('cancelModal');
  const productForm = document.getElementById('productForm');
  const modalTitle = document.getElementById('modalTitle');
  const productName = document.getElementById('productName');
  const productCost = document.getElementById('productCost');
  const productPrice = document.getElementById('productPrice');
  const productQty = document.getElementById('productQty');
  const productRows = document.getElementById('productRows');
  const productCards = document.getElementById('productCards');
  const searchInput = document.getElementById('searchInput');
  const emptyAddBtn = document.getElementById('emptyAddBtn');

  const shopModal = document.getElementById('shopModal');
  const shopBackdrop = document.getElementById('shopBackdrop');
  const cartItemsEl = document.getElementById('cartItems');
  const openCartHeader = document.getElementById('openCartHeader');
  const cartCountHeader = document.getElementById('cartCountHeader');
  const clearCartBtn = document.getElementById('clearCart');
  const closeCartBtn = document.getElementById('closeCart');
  const sellCartBtn = document.getElementById('sellCart');

  const invoiceModal = document.getElementById('invoiceModal');
  const invoiceForm = document.getElementById('invoiceForm');
  const invoiceCustomerName = document.getElementById('customerName');
  const invoiceCustomerPhone = document.getElementById('customerPhone');
  const invoiceDateInputP = document.getElementById('invoiceDate');
  const invoiceTotalEl = document.getElementById('invoiceTotal');
  const invoiceAmountPaid = document.getElementById('amountPaid');
  const invoiceStatusSelect = document.getElementById('status');
  const backToCartBtn = document.getElementById('backToCart');
  const buyRecordBtn = document.getElementById('buyRecord');
  const buyOnlyBtn = document.getElementById('buyOnly');

  // reports
  const reportsRows = document.getElementById('reportsRows');
  const reportsTotalItems = document.getElementById('reportsTotalItems');
  const reportsTotalSales = document.getElementById('reportsTotalSales');
  const reportsExportPdf = document.getElementById('reportsExportPdf');
  const reportsDeleteAll = document.getElementById('reportsDeleteAll');
  const reportsPeriod = document.getElementById('reportsPeriod') || document.getElementById('reportsTimeFilter') || document.getElementById('reportsPeriod');
  const reportsDate = document.getElementById('reportsDate');
  const reportsSearchInput = document.getElementById('reportsSearchInput') || document.getElementById('reportsSearch');

  let editingProductId = null;
  let cart = [];

  /* =========================
     UI: hide nav/settings while on auth
     ========================= */
  function setAuthVisibility(isAuthScreen) {
    // hide nav buttons and settings cog while on login/register
    document.querySelectorAll('.navBtn, .storeSettingsBtn').forEach(el => {
      if (isAuthScreen) el.classList.add('hidden'); else el.classList.remove('hidden');
    });
  }

  /* =========================
     AUTH (registration/login/logout)
     ========================= */
  function showLoginForm() { registrationForm?.classList.add('hidden'); loginForm?.classList.remove('hidden'); setAuthVisibility(true); }
  function showRegisterForm() { registrationForm?.classList.remove('hidden'); loginForm?.classList.add('hidden'); setAuthVisibility(true); }

  // wire toggle links (use buttons to ensure clickable on mobile)
  showLoginBtn?.addEventListener('click', showLoginForm);
  showRegisterBtn?.addEventListener('click', showRegisterForm);

  registerBtn?.addEventListener('click', () => {
    const name = regName.value.trim();
    const address = regAddress.value.trim();
    const phone = regPhone.value.trim();
    const email = regEmail.value.trim();
    const password = regPassword.value;
    const confirm = regConfirm.value;
    if (!name || !address || !phone || !email || !password || !confirm) { toast('Please fill in all fields.', 'error'); return; }
    if (password !== confirm) { toast('Passwords do not match.', 'error'); return; }
    const users = getUsers();
    if (users.find(u => u && u.name && u.name.toLowerCase() === name.toLowerCase())) { toast('Supermarket name taken.', 'error'); return; }
    users.push({ name, address, phone, email, password });
    saveUsers(users);
    toast('Registered. Please login.', 'success');
    regName.value = regAddress.value = regPhone.value = regEmail.value = regPassword.value = regConfirm.value = '';
    showLoginForm();
  });

  loginBtn?.addEventListener('click', () => {
    const name = loginName.value.trim();
    const pwd = loginPassword.value;
    if (!name || !pwd) { toast('Enter name & password', 'error'); return; }
    const users = getUsers();
    const user = users.find(u => u && u.name && u.name.toLowerCase() === name.toLowerCase() && u.password === pwd);
    if (!user) { toast('Invalid credentials', 'error'); return; }
    setCurrentUser(user);
    toast('Logged in', 'success');
    loadDashboard();
  });

  logoutBtn?.addEventListener('click', () => {
    clearCurrentUser();
    authSection?.classList.remove('hidden');
    dashboardSection?.classList.add('hidden');
    showLoginForm();
    setAuthVisibility(true);
  });

  /* =========================
     DASHBOARD: totals & load
     ========================= */
  function updateDashboardTotals() {
    const user = getCurrentUser();
    if (!user) return;
    const invoices = getStoreInvoices(user.name);
    const products = getStoreProducts(user.name);
    totalInvoicesEl && (totalInvoicesEl.textContent = invoices.length);
    totalProductsEl && (totalProductsEl.textContent = (Array.isArray(products) ? products.length : 0));
    const totalSales = invoices.reduce((s, i) => s + (Number(i.paid) || 0), 0);
    totalSalesEl && (totalSalesEl.textContent = fmtMoney(totalSales));
  }

  function loadDashboard() {
    const user = getCurrentUser();
    if (!user) return;
    authSection && authSection.classList.add('hidden');
    dashboardSection && dashboardSection.classList.remove('hidden');
    if (storeDisplayDesktop) {
      storeDisplayDesktop.textContent = user.name;
      applyLanguage(lsGet(LS_APP_LANG, 'en'));
    }
    updateDashboardTotals();
    showSection('dashboardContent');
    setAuthVisibility(false);
    // ensure settings cog exists and is visible
    if (typeof window.AppSettings !== 'undefined' && window.AppSettings && window.AppSettings.createStoreSettingsBtn) {
      try { window.AppSettings.createStoreSettingsBtn(); } catch (e) {}
    }
  }
  window.addEventListener('dataUpdated', updateDashboardTotals);

  /* =========================
     NAV / showSection
     ========================= */
  function showSection(targetId) {
    // hide all main areas inside dashboardSection
    [dashboardContent, invoicesSection, productsSection, reportsSection].forEach(s => s && s.classList.add('hidden'));
    const el = document.getElementById(targetId);
    if (el) el.classList.remove('hidden');
    // refresh content
    if (targetId === "dashboardContent") updateDashboardTotals();
    if (targetId === "invoicesSection") renderInvoiceTable();
    if (targetId === "productsSection") renderProductList(searchInput?.value || '');
    if (targetId === "reportsSection") renderReports();
  }
  navButtons.forEach(btn => btn.addEventListener('click', () => {
    const target = btn.getAttribute('data-target');
    if (target) showSection(target);
  }));

  /* =========================
     CLOCK
     ========================= */
  function tickClock() { const now = new Date(); const hh = String(now.getHours()).padStart(2, '0'); const mm = String(now.getMinutes()).padStart(2, '0'); const ss = String(now.getSeconds()).padStart(2, '0'); currentTimeEl && (currentTimeEl.textContent = `${fmtDate(now)} ${hh}:${mm}:${ss}`); }
  setInterval(tickClock, 1000); tickClock();

  /* =========================
     PRODUCT UI & CART
     ========================= */
  // Make addProductBtn icon-only if present
  if (addProductBtn) { addProductBtn.innerHTML = '<i class="fa-solid fa-plus"></i>'; addProductBtn.title = 'Add product'; }

  function openProductModal(isEdit = false) {
    if (!productModal) return;
    productModal.classList.remove('hidden');
    productModalBackdrop && productModalBackdrop.classList.remove('hidden');
    if (!isEdit) try { productForm.reset(); } catch (e) { }
    modalTitle && (modalTitle.textContent = isEdit ? 'Edit Product' : 'Add Product');
  }
  function closeProductModal() {
    productModal && productModal.classList.add('hidden');
    productModalBackdrop && productModalBackdrop.classList.add('hidden');
  }

  addProductBtn?.addEventListener('click', () => { editingProductId = null; openProductModal(false); });
  emptyAddBtn?.addEventListener('click', () => { editingProductId = null; openProductModal(false); });
  closeModalBtn?.addEventListener('click', closeProductModal);
  cancelModalBtn?.addEventListener('click', closeProductModal);
  productModalBackdrop?.addEventListener('click', closeProductModal);

  productForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = (productName?.value || '').trim();
    const cost = parseFloat(productCost?.value) || 0;
    const price = parseFloat(productPrice?.value) || 0;
    const qty = parseInt(productQty?.value) || 0;
    if (!name || price < 0 || qty < 0) { toast('Fill product fields correctly', 'error'); return; }
    const user = getCurrentUser(); if (!user) { toast('Login required', 'error'); return; }
    const all = getAllProducts();
    if (editingProductId) {
      const idx = all.findIndex(p => p.id === editingProductId && String(p.store || '').toLowerCase() === String(user.name || '').toLowerCase());
      if (idx >= 0) all[idx] = { ...all[idx], name, cost, price, qty };
    } else {
      const id = `PRD-${Date.now()}`; all.push({ id, store: user.name, name, cost, price, qty });
    }
    saveAllProducts(all);
    closeProductModal(); renderProductList(searchInput?.value || ''); window.dispatchEvent(new Event('dataUpdated')); toast('Product saved', 'success');
  });

  function renderProductList(filter = '') {
    const user = getCurrentUser(); if (!user) return;
    const all = getStoreProducts(user.name);
    const q = (filter || '').toString().toLowerCase().trim();
    const items = q ? all.filter(p => (p.name || '').toString().toLowerCase().includes(q)) : all;
    if (!productRows || !productCards) return;
    productRows.innerHTML = ''; productCards.innerHTML = '';
    // desktop table uses productRows (tbody)
    const emptyEl = document.getElementById('emptyState');
    if (!items.length) { emptyEl && emptyEl.classList.remove('hidden'); return; } else emptyEl && emptyEl.classList.add('hidden');

    // Desktop table rows
    items.forEach((p, idx) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      // actions icon-only
      tr.innerHTML = `
        <td class="p-2">${idx + 1}</td>
        <td class="p-2">${escapeHtml(p.name)}</td>
        <td class="p-2">${Number(p.cost||0).toFixed(2)}</td>
        <td class="p-2">${Number(p.price||0).toFixed(2)}</td>
        <td class="p-2">${p.qty}</td>
        <td class="p-2 no-print">
          <div class="flex gap-2">
            <button class="action-icon" data-action="buy" data-id="${p.id}" title="Add to cart"><i class="fa-solid fa-cart-shopping"></i></button>
            <button class="action-icon" data-action="edit" data-id="${p.id}" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
            <button class="action-icon text-red-600" data-action="delete" data-id="${p.id}" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </td>
      `;
      productRows.appendChild(tr);
    });

    // Mobile cards
    items.forEach((p) => {
      const card = document.createElement('div');
      card.className = 'bg-white dark:bg-gray-800 rounded-xl p-3 shadow flex flex-col';
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-semibold">${escapeHtml(p.name)}</h4>
            <div class="text-sm text-gray-500">Price: ${Number(p.price||0).toFixed(2)} | Qty: ${p.qty}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div class="text-sm font-semibold">${Number(p.price||0).toFixed(2)}</div>
            <div class="flex gap-1">
              <button class="action-icon" data-action="buy" data-id="${p.id}" title="Add to cart"><i class="fa-solid fa-cart-shopping"></i></button>
              <button class="action-icon" data-action="edit" data-id="${p.id}" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
              <button class="action-icon text-red-600" data-action="delete" data-id="${p.id}" title="Delete"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>
      `;
      productCards.appendChild(card);
    });
  }

  // search
  searchInput?.addEventListener('input', e => renderProductList(e.target.value));

  // product actions delegation
  productRows?.addEventListener('click', e => {
    const btn = e.target.closest('button[data-action]'); if (!btn) return;
    const act = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id'); handleProductAction(act, id);
  });
  productCards?.addEventListener('click', e => {
    const btn = e.target.closest('button[data-action]'); if (!btn) return;
    const act = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id'); handleProductAction(act, id);
  });

  function handleProductAction(action, id) {
    const user = getCurrentUser(); if (!user) return;
    const all = getAllProducts();
    const idx = all.findIndex(p => p.id === id && String(p.store || '').toLowerCase() === String(user.name || '').toLowerCase());
    if (action === 'edit' && idx >= 0) {
      const prod = all[idx]; editingProductId = id; modalTitle && (modalTitle.textContent = 'Edit Product'); productName.value = prod.name; productCost.value = prod.cost; productPrice.value = prod.price; productQty.value = prod.qty; openProductModal(true); return;
    }
    if (action === 'delete' && idx >= 0) {
      if (!confirm('Delete this product?')) return;
      all.splice(idx, 1); saveAllProducts(all); renderProductList(searchInput?.value || ''); window.dispatchEvent(new Event('dataUpdated')); toast('Product deleted', 'success'); return;
    }
    if (action === 'buy' && idx >= 0) { addToCart(id); return; }
  }

  /* CART */
  function addToCart(productId) {
    const user = getCurrentUser(); if (!user) return;
    const all = getAllProducts();
    const prod = all.find(p => p.id === productId && String(p.store || '').toLowerCase() === String(user.name || '').toLowerCase());
    if (!prod) return toast('Product not found.', 'error');
    const existing = cart.find(c => c.id === productId);
    const existingQty = existing ? existing.qty : 0;
    if (existingQty + 1 > prod.qty) return toast('Not enough stock.', 'error');
    if (existing) existing.qty += 1; else cart.push({ id: prod.id, name: prod.name, price: Number(prod.price), qty: 1 });
    renderCart();
    toast('Added to cart', 'success');
  }

  function renderCart() {
    if (!cartItemsEl) return;
    cartItemsEl.innerHTML = '';
    let totalCount = 0, totalAmount = 0;
    if (!cart.length) { cartItemsEl.innerHTML = '<p class="text-gray-500">Cart is empty.</p>'; }
    else {
      cart.forEach(item => {
        totalCount += item.qty; totalAmount += item.price * item.qty;
        const row = document.createElement('div'); row.className = 'flex justify-between items-center gap-3 p-2 border-b';
        row.innerHTML = `<div><div class="font-semibold">${escapeHtml(item.name)}</div><div class="text-sm">Price: ${fmtMoney(item.price)} | Qty: ${item.qty}</div></div>
          <div class="flex flex-col items-end gap-2"><div class="text-sm font-semibold">${fmtMoney(item.price * item.qty)}</div><div class="flex gap-1"><button class="px-2 py-1 bg-gray-200 rounded" data-decrease="${item.id}">-</button><button class="px-2 py-1 bg-gray-200 rounded" data-increase="${item.id}">+</button></div><button class="px-2 py-1 bg-red-500 text-white rounded mt-1" data-remove="${item.id}">Remove</button></div>`;
        cartItemsEl.appendChild(row);
      });
    }
    cartCountHeader && (cartCountHeader.textContent = totalCount);
    shopModal && (shopModal.dataset.total = totalAmount);
  }

  cartItemsEl?.addEventListener('click', e => {
    const idRemove = e.target.getAttribute('data-remove'); const idInc = e.target.getAttribute('data-increase'); const idDec = e.target.getAttribute('data-decrease');
    const user = getCurrentUser(); if (!user) return;
    const all = getAllProducts();
    if (idRemove) { cart = cart.filter(i => i.id !== idRemove); renderCart(); return; }
    if (idInc) {
      const prod = all.find(p => p.id === idInc && String(p.store || '').toLowerCase() === String(user.name || '').toLowerCase()); if (!prod) return toast('Product not found.', 'error');
      const it = cart.find(i => i.id === idInc); if (it.qty + 1 > prod.qty) return toast('Not enough stock.', 'error'); it.qty += 1; renderCart(); return;
    }
    if (idDec) {
      const it = cart.find(i => i.id === idDec); if (!it) return; it.qty = Math.max(0, it.qty - 1); if (it.qty === 0) cart = cart.filter(i => i.id !== idDec); renderCart(); return;
    }
  });

  openCartHeader?.addEventListener('click', () => { shopModal?.classList.remove('hidden'); shopBackdrop?.classList.remove('hidden'); renderCart(); });
  closeCartBtn?.addEventListener('click', () => { shopModal?.classList.add('hidden'); shopBackdrop?.classList.add('hidden'); });
  shopBackdrop?.addEventListener('click', () => { shopModal?.classList.add('hidden'); shopBackdrop?.classList.add('hidden'); });
  clearCartBtn?.addEventListener('click', () => { if (!confirm('Clear all items from cart?')) return; cart = []; renderCart(); });

  sellCartBtn?.addEventListener('click', () => {
    if (!cart.length) return toast('Cart empty.', 'error');
    invoiceCustomerName && (invoiceCustomerName.value = ''); invoiceCustomerPhone && (invoiceCustomerPhone.value = '+252'); invoiceDateInputP && (invoiceDateInputP.value = fmtDate(new Date()));
    const total = Number(shopModal?.dataset.total || 0); invoiceTotalEl && (invoiceTotalEl.textContent = fmtMoney(total)); invoiceAmountPaid && (invoiceAmountPaid.value = ''); invoiceStatusSelect && (invoiceStatusSelect.value = 'unpaid');
    invoiceModal?.classList.remove('hidden'); shopModal?.classList.add('hidden'); shopBackdrop?.classList.add('hidden');
  });
  backToCartBtn?.addEventListener('click', () => { invoiceModal?.classList.add('hidden'); shopModal?.classList.remove('hidden'); shopBackdrop?.classList.remove('hidden'); });

  /* buyRecord (checkout) */
  buyRecordBtn?.addEventListener('click', () => {
    const cust = invoiceCustomerName?.value.trim(); const phone = invoiceCustomerPhone?.value.trim();
    const date = invoiceDateInputP?.value || fmtDate(new Date()); const paid = Number(invoiceAmountPaid?.value) || 0; const status = invoiceStatusSelect?.value || 'unpaid'; const total = Number(shopModal?.dataset.total || 0);
    if (!cust) { toast('Customer name required', 'error'); return; } if (!phone) { toast('Customer phone required', 'error'); return; }
    const allProducts = getAllProducts(); for (const c of cart) { const prod = allProducts.find(p => p.id === c.id); if (!prod || prod.qty < c.qty) return toast(`Not enough stock for ${c.name}.`, 'error'); }
    const invId = `INV-${Date.now()}`; const invoiceItems = cart.map(i => ({ name: i.name, price: i.price, qty: i.qty, total: i.price * i.qty }));
    const invoicePayload = { id: invId, store: getCurrentUser().name, date, customer: cust, phone, items: invoiceItems, amount: total, paid, status };
    const allInv = getAllInvoices(); allInv.push(invoicePayload); saveAllInvoices(allInv);
    createReportEntry({ id: `RPT-${Date.now()}`, date, store: getCurrentUser().name, items: invoiceItems, amount: total, paid, status, customer: cust, phone });
    for (const c of cart) { const idx = allProducts.findIndex(p => p.id === c.id && String(p.store || '').toLowerCase() === String(getCurrentUser().name || '').toLowerCase()); if (idx >= 0) allProducts[idx].qty = Math.max(0, allProducts[idx].qty - c.qty); }
    saveAllProducts(allProducts); cart = []; renderCart(); renderProductList(searchInput?.value || ''); invoiceModal?.classList.add('hidden'); window.dispatchEvent(new Event('dataUpdated')); toast('Sold & recorded.', 'success');
  });

  /* buyOnly */
  buyOnlyBtn?.addEventListener('click', () => {
    if (!cart.length) return toast('Cart empty', 'error'); const date = invoiceDateInputP?.value || fmtDate(new Date()); const total = Number(shopModal?.dataset.total || 0);
    const allProducts = getAllProducts(); for (const c of cart) { const prod = allProducts.find(p => p.id === c.id); if (!prod || prod.qty < c.qty) return toast(`Not enough stock for ${c.name}.`, 'error'); }
    const invoiceItems = cart.map(i => ({ name: i.name, price: i.price, qty: i.qty, total: i.price * i.qty }));
    createReportEntry({ id: `RPT-${Date.now()}`, date, store: getCurrentUser().name, items: invoiceItems, amount: total, paid: 0, status: 'unpaid', customer: 'Walk-in Customer', phone: '+252000000000' });
    for (const c of cart) { const idx = allProducts.findIndex(p => p.id === c.id && String(p.store || '').toLowerCase() === String(getCurrentUser().name || '').toLowerCase()); if (idx >= 0) allProducts[idx].qty = Math.max(0, allProducts[idx].qty - c.qty); }
    saveAllProducts(allProducts); cart = []; renderCart(); renderProductList(searchInput?.value || ''); invoiceModal?.classList.add('hidden'); window.dispatchEvent(new Event('dataUpdated')); toast('Recorded in Reports.', 'success');
  });

  /* report helper */
  function createReportEntry({ id, date, store, items, amount, paid = 0, status = null, customer, phone, type = "sale" }) {
    const reports = getAllReports();
    const itemsArr = Array.isArray(items) ? items : (items ? [items] : []);
    const computedAmount = Number(amount) || itemsArr.reduce((s, it) => { const qty = Number(it?.qty ?? it?.quantity ?? 1); const line = Number(it?.total ?? (it?.price ? it.price * qty : 0)); return s + (isFinite(line) ? line : 0); }, 0);
    const paidNum = Number(paid || 0);
    const computedStatus = status || (paidNum >= computedAmount ? 'paid' : 'unpaid');
    const payload = { id: id || `RPT-${Date.now()}`, date: date || Date.now(), store: store || (getCurrentUser && getCurrentUser().name) || null, items: itemsArr, amount: Number(computedAmount), paid: paidNum, due: Number((computedAmount - paidNum) || 0), status: computedStatus, type, customer: customer || 'Walk-in Customer', phone: phone || '+252000000000' };
    reports.push(payload); saveAllReports(reports); window.dispatchEvent(new Event('dataUpdated'));
  }

  /* =========================
     INVOICES UI (create/edit/list/actions)
     ========================= */

  function makeItemRow(data = {}) {
    const row = document.createElement('div');
    row.className = 'grid sm:grid-cols-4 gap-2 mb-2 items-end';
    const safeName = (data.name || data.product || '').toString().replace(/"/g, '&quot;');
    const safePrice = Number(data.price ?? data.total ?? 0);
    row.innerHTML = `
      <input class="col-span-2 item-name border rounded-xl px-3 py-2" placeholder="Item name" value="${escapeHtml(safeName)}">
      <input type="number" min="0" step="0.01" class="item-price border rounded-xl px-3 py-2" placeholder="Price" value="${safePrice}">
      <div class="flex items-center gap-2">
        <input readonly class="item-total flex-1 border rounded-xl px-3 py-2 bg-gray-50" value="${fmtMoney(safePrice)}">
        <button type="button" class="remove-item px-3 py-2 rounded bg-red-500 text-white">‚úï</button>
      </div>
    `;
    const priceEl = row.querySelector('.item-price');
    const totalEl = row.querySelector('.item-total');
    function recalc() { const p = parseFloat(priceEl.value) || 0; totalEl.value = fmtMoney(p); recalcInvoiceTotals(); }
    priceEl.addEventListener('input', recalc);
    row.querySelector('.remove-item').addEventListener('click', () => { row.remove(); recalcInvoiceTotals(); });
    return row;
  }

  function recalcInvoiceTotals() {
    if (!invoiceItemsContainer) return;
    const rows = Array.from(invoiceItemsContainer.querySelectorAll('.item-total'));
    const total = rows.reduce((s, el) => s + (Number(el.value) || 0), 0);
    amountInput && (amountInput.value = fmtMoney(total));
    const paid = Number(paidInput?.value) || 0;
    if (statusSelect) statusSelect.value = paid >= total && total > 0 ? 'paid' : 'unpaid';
  }
  paidInput?.addEventListener('input', recalcInvoiceTotals);

  function resetInvoiceForm() {
    if (!editingInvoiceId) return;
    editingInvoiceId.value = '';
    customerNameInput.value = '';
    customerPhoneInput.value = '';
    invoiceDateInput.value = fmtDate(new Date());
    amountInput && (amountInput.value = '0.00');
    paidInput && (paidInput.value = '');
    if (statusSelect) statusSelect.value = 'unpaid';
    invoiceItemsContainer && (invoiceItemsContainer.innerHTML = '');
    invoiceItemsContainer && invoiceItemsContainer.appendChild(makeItemRow());
    formMsg && formMsg.classList.add('hidden');
    formMsg && (formMsg.textContent = '');
  }

  // create/open invoice toggle - hidden until clicked; createInvoiceSection has hidden-section default
  createInvoiceBtn?.addEventListener('click', () => {
    if (!createInvoiceSection) return;
    if (createInvoiceSection.classList.contains('hidden') || createInvoiceSection.classList.contains('hidden-section')) {
      resetInvoiceForm();
      createInvoiceSection.classList.remove('hidden', 'hidden-section');
    } else {
      createInvoiceSection.classList.add('hidden-section');
    }
  });

  addItemBtn?.addEventListener('click', () => { invoiceItemsContainer && invoiceItemsContainer.appendChild(makeItemRow()); recalcInvoiceTotals(); });

  saveInvoiceBtn?.addEventListener('click', () => {
    const user = getCurrentUser();
    if (!user) { toast('You must be logged in.', 'error'); return; }
    const name = customerNameInput?.value.trim();
    const phone = customerPhoneInput?.value.trim();
    const date = invoiceDateInput?.value || fmtDate(new Date());
    // collect items robustly
    const items = invoiceItemsContainer ? Array.from(invoiceItemsContainer.querySelectorAll('.grid')).map(r => {
      const nm = r.querySelector('.item-name')?.value.trim() || '';
      const price = parseFloat(r.querySelector('.item-price')?.value) || 0;
      return { name: nm, price, total: price, qty: 1 };
    }).filter(it => it.name && it.price > 0) : [];

    if (!items.length) { showFormError('Add at least one item with name and price.'); return; }
    const amount = Number(amountInput?.value) || 0;
    const paid = Number(paidInput?.value) || 0;
    const status = statusSelect?.value || 'unpaid';

    if (!name) { showFormError('Customer name required'); return; }
    if (!phone) { showFormError('Customer phone required'); return; }

    const all = getAllInvoices();
    const id = editingInvoiceId?.value || `INV-${Date.now()}`;
    const payload = { id, store: user.name, date, customer: name, phone, items, amount, paid, status };
    const idx = all.findIndex(x => x.id === id);
    if (idx >= 0) all[idx] = payload; else all.push(payload);
    saveAllInvoices(all);
    resetInvoiceForm();
    createInvoiceSection.classList.add('hidden');
    renderInvoiceTable();
    window.dispatchEvent(new Event('dataUpdated'));
    toast('Invoice saved', 'success');
  });

  function showFormError(msg) { formMsg && (formMsg.textContent = msg, formMsg.classList.remove('hidden')); toast(msg, 'error'); }

  /* ============= INVOICE LIST & ACTIONS ============= */
  function filteredInvoicesForUI() {
    const user = getCurrentUser();
    if (!user) return [];
    const statusVal = filterStatus?.value || 'all';
    const searchVal = (searchName?.value || '').toLowerCase();
    return getStoreInvoices(user.name).filter(inv => {
      const statusOk = statusVal === 'all' ? true : inv.status === statusVal;
      const searchOk = !searchVal || (inv.customer && inv.customer.toLowerCase().includes(searchVal)) || (inv.phone && String(inv.phone).includes(searchVal)) || (inv.id && inv.id.toLowerCase().includes(searchVal));
      return statusOk && searchOk;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
  }

  function renderInvoiceTable() {
    if (!invoiceRows) return;
    const list = filteredInvoicesForUI();
    invoiceRows.innerHTML = '';
    if (!list.length) {
      emptyStateInv && emptyStateInv.classList.remove('hidden'); return;
    } else {
      emptyStateInv && emptyStateInv.classList.add('hidden');
    }
    const mobile = window.matchMedia('(max-width:640px)').matches;
    const storeName = getCurrentUser()?.name || '';
    list.forEach((invObj, idx) => {
      const balance = Math.max(0, (Number(invObj.amount) || 0) - (Number(invObj.paid) || 0));
      const balanceColorClass = balance <= 0 ? 'text-emerald-600' : 'text-rose-600';
      if (mobile) {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td colspan="10" class="p-2">
            <div class="sm-card p-3 bg-white rounded-xl shadow-sm">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-semibold">${(storeName || 'S').slice(0, 2).toUpperCase()}</div>
                <div style="flex:1;">
                  <div class="font-semibold">Invoice ${escapeHtml(invObj.id)}</div>
                  <div class="text-sm text-gray-500">${fmtDate(invObj.date)} ‚Ä¢ ${escapeHtml(invObj.customer || '')}</div>
                </div>
              </div>
              <div class="mt-3 flex items-center justify-between">
                <div class="text-sm">${escapeHtml(invObj.phone || '')}</div>
                <div class="text-right">
                  <div class="font-semibold">${fmtMoney(invObj.amount)}</div>
                  <div class="text-xs ${balanceColorClass}">${escapeHtml(invObj.status)} ‚Ä¢ ${fmtMoney(balance)}</div>
                </div>
              </div>
              <div class="mt-3 flex items-center gap-2 flex-wrap">
                <button class="action-icon" data-action="edit" data-id="${invObj.id}" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="action-icon" data-action="toggle" data-id="${invObj.id}" title="Toggle">${invObj.status === 'paid' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-xmark"></i>'}</button>
                <button class="action-icon" data-action="wa" data-id="${invObj.id}" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
                <button class="action-icon" data-action="sms" data-id="${invObj.id}" title="SMS"><i class="fas fa-sms"></i></button>
                <button class="action-icon" data-action="call" data-id="${invObj.id}" title="Call"><i class="fas fa-phone"></i></button>
                <button class="action-icon" data-action="print" data-id="${invObj.id}" title="Print"><i class="fas fa-print"></i></button>
                <button class="action-icon text-red-600" data-action="delete" data-id="${invObj.id}" title="Delete"><i class="fas fa-trash"></i></button>
                <button class="action-icon share-btn" data-action="share" data-id="${invObj.id}" title="Share"><i class="fas fa-share-nodes"></i></button>
              </div>
            </div>
          </td>
        `;
        invoiceRows.appendChild(tr);
      } else {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2">${idx + 1}</td>
          <td class="p-2">${escapeHtml(invObj.id)}</td>
          <td class="p-2">${fmtDate(invObj.date)}</td>
          <td class="p-2">${escapeHtml(invObj.customer || '')}</td>
          <td class="p-2">${escapeHtml(invObj.phone || '')}</td>
          <td class="p-2 text-right">${fmtMoney(invObj.amount)}</td>
          <td class="p-2 text-right">${fmtMoney(invObj.paid)}</td>
          <td class="p-2 text-right ${balanceColorClass}">${fmtMoney(balance)}</td>
          <td class="p-2"><span class="${invObj.status === 'paid' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'} px-2 py-1 rounded text-xs">${escapeHtml(invObj.status)}</span></td>
          <td class="p-2 no-print">
            <div class="flex gap-2">
              <button class="action-icon" data-action="edit" data-id="${invObj.id}" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="action-icon" data-action="toggle" data-id="${invObj.id}" title="Toggle">${invObj.status === 'paid' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-xmark"></i>'}</button>
              <button class="action-icon" data-action="wa" data-id="${invObj.id}" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
              <button class="action-icon" data-action="sms" data-id="${invObj.id}" title="SMS"><i class="fas fa-sms"></i></button>
              <button class="action-icon" data-action="call" data-id="${invObj.id}" title="Call"><i class="fas fa-phone"></i></button>
              <button class="action-icon" data-action="print" data-id="${invObj.id}" title="Print"><i class="fas fa-print"></i></button>
              <button class="action-icon text-red-600" data-action="delete" data-id="${invObj.id}" title="Delete"><i class="fas fa-trash"></i></button>
              <button class="action-icon share-btn" data-action="share" data-id="${invObj.id}" title="Share"><i class="fas fa-share-nodes"></i></button>
            </div>
          </td>
        `;
        invoiceRows.appendChild(tr);
      }
    });
  }

  // invoice action listener
  invoiceRows?.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    const all = getAllInvoices();
    const idx = all.findIndex(x => x.id === id);
    if (idx < 0) return;
    const user = getCurrentUser();
    if (!user || String(all[idx].store || '').toLowerCase() !== String(user.name || '').toLowerCase()) { toast('Not allowed', 'error'); return; }

    if (action === 'delete') {
      if (confirm('Delete this invoice?')) {
        all.splice(idx, 1); saveAllInvoices(all); renderInvoiceTable(); window.dispatchEvent(new Event('dataUpdated')); toast('Invoice deleted', 'success');
      }
    } else if (action === 'toggle') {
      if (all[idx].status === 'unpaid') {
        all[idx].prevPaid = all[idx].paid;
        all[idx].status = 'paid';
        all[idx].paid = Number(all[idx].amount) || 0;
      } else {
        all[idx].status = 'unpaid';
        all[idx].paid = all[idx].prevPaid || 0;
      }
      saveAllInvoices(all); renderInvoiceTable(); window.dispatchEvent(new Event('dataUpdated'));
    } else if (action === 'edit') {
      const invObj = all[idx];
      createInvoiceSection?.classList.remove('hidden', 'hidden-section');
      editingInvoiceId && (editingInvoiceId.value = invObj.id);
      customerNameInput && (customerNameInput.value = invObj.customer || '');
      customerPhoneInput && (customerPhoneInput.value = invObj.phone || '');
      invoiceDateInput && (invoiceDateInput.value = invObj.date || fmtDate(new Date()));
      amountInput && (amountInput.value = fmtMoney(invObj.amount || 0));
      paidInput && (paidInput.value = invObj.paid || 0);
      statusSelect && (statusSelect.value = invObj.status || 'unpaid');
      if (invoiceItemsContainer) {
        invoiceItemsContainer.innerHTML = '';
        (invObj.items || []).forEach(it => invoiceItemsContainer.appendChild(makeItemRow(it)));
        if ((invObj.items || []).length === 0) invoiceItemsContainer.appendChild(makeItemRow());
      }
    } else if (action === 'wa') {
      sendReminderFor(all[idx], 'wa');
    } else if (action === 'sms') {
      sendReminderFor(all[idx], 'sms');
    } else if (action === 'call') {
      const phone = cleanPhone(all[idx].phone || '');
      if (!phone) return toast('No phone provided', 'error');
      window.open(`tel:+${phone}`, '_self');
    } else if (action === 'print') {
      // print invoice (open printable new window and call print)
      printInvoice(all[idx]);
    } else if (action === 'share') {
      const card = btn.closest('.sm-card') || btn.closest('tr') || btn.parentElement;
      if (card) captureElementAsImage(card, `${all[idx].id}_${Date.now()}.png`);
      else toast('Cannot locate card to share.', 'error');
    }
  });

  /* =========================
     PRINT / CAPTURE
     ========================= */
  function printInvoice(inv) {
    const balance = Math.max(0, (Number(inv.amount) || 0) - (Number(inv.paid) || 0));
    const win = window.open('', 'PRINT', 'height=650,width=900');
    const store = getCurrentUser() || {};
    const head = `
      <html><head><title>Invoice ${escapeHtml(inv.id)}</title>
      <style>
        body{font-family:sans-serif;padding:20px;color:#111}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        td,th{border:1px solid #ddd;padding:8px}
        th{background:#f4f4f4}
      </style>
      </head><body>`;
    const footer = `</body></html>`;
    const content = `
      <h1>Invoice ${escapeHtml(inv.id)}</h1>
      <p><strong>Store:</strong> ${escapeHtml(store.name||'Supermarket')}<br/>
      <strong>Date:</strong> ${fmtDate(inv.date)}<br/>
      <strong>Customer:</strong> ${escapeHtml(inv.customer||'Walk-in')}<br/>
      <strong>Phone:</strong> ${escapeHtml(inv.phone||'')}</p>
      <table><thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
      <tbody>
      ${(inv.items||[]).map(it => `<tr><td>${escapeHtml(it.name||it.product||'Item')}</td><td>${it.qty||1}</td><td>${fmtMoney(it.price||0)}</td><td>${fmtMoney(it.total||((it.price||0)*(it.qty||1)))}</td></tr>`).join('')}
      </tbody></table>
      <p><strong>Amount:</strong> ${fmtMoney(inv.amount)}<br/>
      <strong>Paid:</strong> ${fmtMoney(inv.paid)}<br/>
      <strong>Balance:</strong> ${fmtMoney(balance)}<br/>
      <strong>Status:</strong> ${escapeHtml(inv.status)}</p>
    `;
    win.document.write(head + content + footer);
    win.document.close();
    win.focus();
    // small delay to ensure render
    setTimeout(() => { try { win.print(); } catch (e) { toast('Print failed', 'error'); } }, 250);
  }

  function captureElementAsImage(el, filename = 'capture.png') {
    if (!el) return toast('Nothing to capture', 'error');
    if (typeof html2canvas === 'undefined') {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      s.onload = () => doCapture();
      s.onerror = () => toast('Failed to load capture library.', 'error');
      document.head.appendChild(s);
    } else doCapture();
    function doCapture() {
      // use html2canvas to get image
      html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
        const data = canvas.toDataURL('image/png');
        const a = document.createElement('a'); a.href = data; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      }).catch(err => { console.error(err); toast('Capture failed', 'error'); });
    }
  }

  /* =========================
     FILTERS / clear paid
     ========================= */
  filterStatus?.addEventListener('change', renderInvoiceTable);
  searchName?.addEventListener('input', renderInvoiceTable);
  clearPaidBtn?.addEventListener('click', () => {
    const user = getCurrentUser(); if (!user) return;
    if (!confirm('Clear all PAID invoices?')) return;
    let all = getAllInvoices();
    all = all.filter(inv => !(String(inv.store || '').toLowerCase() === String(user.name || '').toLowerCase() && inv.status === 'paid'));
    saveAllInvoices(all); renderInvoiceTable(); window.dispatchEvent(new Event('dataUpdated')); toast('Paid invoices removed', 'success');
  });

  /* =========================
     REMINDERS / MESSAGING
     ========================= */
  function sendReminderForSingle(invObj, method) {
    if (!invObj) return;
    const phone = cleanPhone(invObj.phone || '');
    if (!phone) return toast('No phone number for this invoice.', 'error');
    const balance = Math.max(0, (Number(invObj.amount) || 0) - (Number(invObj.paid) || 0));
    const tpl = lsGet(LS_MSG_TPL, {});
    const defaultWa = tpl.reminder_wa || "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}. Fadlan iska bixi dukaanka {store} ({phone}).";
    const defaultSms = tpl.reminder_sms || defaultWa;
    const template = method === 'wa' ? defaultWa : defaultSms;
    const storeName = getCurrentUser()?.name || '';
    const storePhone = (getCurrentUser()?.phone) || '';
    const msg = template.replace(/\{customer\}/gi, invObj.customer || '')
      .replace(/\{id\}/gi, invObj.id || '')
      .replace(/\{balance\}/gi, fmtMoney(balance))
      .replace(/\{store\}/gi, storeName)
      .replace(/\{phone\}/gi, storePhone);
    if (method === 'wa') {
      window.open(`https://wa.me/${phone.replace('+', '')}?text=${encodeURIComponent(msg)}`, '_blank');
    } else {
      window.open(`sms:+${phone}?&body=${encodeURIComponent(msg)}`, '_blank');
    }
  }

  function sendReminderForGrouped(group, method) {
    const phone = cleanPhone(group.phone || '');
    if (!phone) return toast('No phone for group.', 'error');
    const tpl = lsGet(LS_MSG_TPL, {});
    const defaultWa = tpl.reminder_wa || "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}. Fadlan iska bixi dukaanka {store} ({phone}).";
    const defaultSms = tpl.reminder_sms || defaultWa;
    const template = method === 'wa' ? defaultWa : defaultSms;
    const storeName = getCurrentUser()?.name || '';
    const storePhone = (getCurrentUser()?.phone) || '';
    const ids = group.invoices.map(i => i.id).join(',');
    const msg = template.replace(/\{customer\}/gi, group.customer || '')
      .replace(/\{id\}/gi, ids)
      .replace(/\{balance\}/gi, fmtMoney(group.totalBalance || 0))
      .replace(/\{store\}/gi, storeName)
      .replace(/\{phone\}/gi, storePhone);
    if (method === 'wa') {
      window.open(`https://wa.me/${phone.replace('+', '')}?text=${encodeURIComponent(msg)}`, '_blank');
    } else {
      window.open(`sms:+${phone}?&body=${encodeURIComponent(msg)}`, '_blank');
    }
  }

  /* confirmation modal for reminders */
  function createReminderConfirmModal() {
    let modal = document.getElementById('reminderConfirmModal');
    if (modal) return modal;
    const html = `
      <div id="reminderConfirmModal" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="relative max-w-lg w-full bg-white dark:bg-gray-800 rounded-lg shadow p-4">
          <h3 id="reminderConfirmHeader" class="text-lg font-semibold mb-2"></h3>
          <div id="reminderConfirmBody" class="mb-4 whitespace-pre-line"></div>
          <div class="flex justify-end gap-2">
            <button id="reminderCancelBtn" class="px-3 py-2 rounded bg-gray-200">Cancel</button>
            <button id="reminderOkBtn" class="px-3 py-2 rounded bg-emerald-600 text-white">OK</button>
          </div>
        </div>
      </div>
    `;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    document.body.appendChild(wrapper);
    return document.getElementById('reminderConfirmModal');
  }

  function showReminderConfirm(group, progressStr, messageText) {
    return new Promise((resolve) => {
      const modal = createReminderConfirmModal();
      const header = modal.querySelector('#reminderConfirmHeader');
      const body = modal.querySelector('#reminderConfirmBody');
      const okBtn = modal.querySelector('#reminderOkBtn');
      const cancelBtn = modal.querySelector('#reminderCancelBtn');
      header.textContent = `${progressStr} Xasuusin ${group.customer || ''}`;
      body.textContent = messageText;
      function cleanup() { modal.classList.add('hidden'); okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); }
      function onOk() { cleanup(); resolve(true); }
      function onCancel() { cleanup(); resolve(false); }
      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
      modal.classList.remove('hidden');
      okBtn.focus();
    });
  }

  async function sendAllRemindersFlow(method) {
    const user = getCurrentUser();
    if (!user) return toast('Login required', 'error');

    // gather invoices that owe money and have phone
    const invoices = filteredInvoicesForUI().filter(inv => {
      const bal = (Number(inv.amount) || 0) - (Number(inv.paid) || 0);
      return inv.phone && bal > 0;
    });
    if (!invoices.length) return toast('No customers need reminders based on current filter/search.', 'info');

    // group by phone + customer
    const groupsMap = new Map();
    invoices.forEach(inv => {
      const phone = cleanPhone(inv.phone || '');
      const customer = (inv.customer || '').trim();
      const key = `${phone}||${customer}`;
      const bal = Math.max(0, (Number(inv.amount) || 0) - (Number(inv.paid) || 0));
      if (!groupsMap.has(key)) groupsMap.set(key, { customer, phone, totalBalance: 0, invoices: [] });
      const g = groupsMap.get(key);
      g.totalBalance += bal;
      g.invoices.push(inv);
    });

    const groups = Array.from(groupsMap.values());
    for (let i = 0; i < groups.length; i++) {
      const g = groups[i];
      const progressStr = `${i + 1}/${groups.length}`;
      const storeName = user.name || '';
      const storePhone = user.phone || '';
      const preview = `Xasuusin: ${g.customer}\nLacagta lagugu leeyahay waa: ${fmtMoney(g.totalBalance)}\nFadlan iska bixi dukaanka ${storeName} (${storePhone})`;
      const confirmed = await showReminderConfirm(g, progressStr, preview);
      if (!confirmed) return;
      sendReminderForGrouped(g, method);
      await new Promise(res => setTimeout(res, 300));
    }
  }

  sendAllRemindersBtn?.addEventListener('click', async () => {
    const method = (reminderMethod?.value) || 'wa';
    await sendAllRemindersFlow(method);
  });

  /* single invoice reminder */
  function sendReminderFor(invObj, method) {
    const phone = cleanPhone(invObj.phone || '');
    if (!phone) return toast('No phone provided', 'error');
    const storeName = getCurrentUser()?.name || '';
    const storePhone = getCurrentUser()?.phone || '';
    const balance = Math.max(0, (Number(invObj.amount) || 0) - (Number(invObj.paid) || 0));
    const preview = `Xasuusin: ${invObj.customer}\nLacagta lagugu leeyahay waa: ${fmtMoney(balance)}\nFadlan iska bixi dukaanka ${storeName} (${storePhone})`;
    showReminderConfirm({ customer: invObj.customer, phone: invObj.phone, invoices: [invObj], totalBalance: balance }, `1/1`, preview).then(ok => {
      if (ok) sendReminderForSingle(invObj, method);
    });
  }

  /* =========================
     REPORTS: filtering, render, export, delete
     ========================= */

  // parse period filter and return filtered reports for current store
  function getReportsFiltered(period = 'lifetime', dateStr = '', search = '') {
    const user = getCurrentUser(); if (!user) return [];
    const all = getAllReports().filter(r => String(r.store || '').toLowerCase() === String(user.name || '').toLowerCase());
    const s = (search || '').toLowerCase().trim();
    const filtered = all.filter(r => {
      if (s) {
        const prodMatch = (r.items || []).some(it => (it.name || '').toLowerCase().includes(s));
        const custMatch = (r.customer || '').toLowerCase().includes(s);
        if (!(prodMatch || custMatch)) return false;
      }
      if (!period || period === 'lifetime' || period === 'all') return true;
      const d = new Date(r.date);
      if (isNaN(d)) return false;
      const target = dateStr ? new Date(dateStr) : new Date();
      if (period === 'daily') {
        return d.getFullYear() === target.getFullYear() && d.getMonth() === target.getMonth() && d.getDate() === target.getDate();
      } else if (period === 'weekly') {
        // last 7 days ending at target (inclusive)
        const t = new Date(target); t.setHours(0, 0, 0, 0);
        const start = new Date(t); start.setDate(t.getDate() - 6);
        return d >= start && d <= t;
      } else if (period === 'monthly') {
        return d.getFullYear() === target.getFullYear() && d.getMonth() === target.getMonth();
      } else if (period === 'yearly') {
        return d.getFullYear() === target.getFullYear();
      }
      return true;
    });
    // sort desc by date
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    return filtered;
  }




  
// render reports into table (desktop) or cards (mobile)
function renderReports() {
  if (!reportsRows) return;
  const period = (reportsPeriod?.value) || 'lifetime';
  const dateStr = (reportsDate?.value) || '';
  const search = (reportsSearchInput?.value || '').toLowerCase();
  const list = getReportsFiltered(period, dateStr, search);

  reportsRows.innerHTML = '';

  // summary counts
  reportsTotalItems && (reportsTotalItems.textContent = list.reduce((s, r) => s + (Array.isArray(r.items) ? r.items.length : 0), 0));
  reportsTotalSales && (reportsTotalSales.textContent = fmtMoney(list.reduce((s, r) => s + (Number(r.amount) || 0), 0)));

  // empty message
  if (!list.length) {
    document.getElementById('reportsEmptyMsg')?.classList.remove('hidden');
  } else {
    document.getElementById('reportsEmptyMsg')?.classList.add('hidden');
  }

  const mobile = window.matchMedia('(max-width:640px)').matches;

  if (mobile) {
    // hide table header + table scroll wrapper
    document.getElementById('reportsTableHead')?.classList.add('hidden');
    document.getElementById('reportsTableWrapper')?.classList.add('overflow-hidden');

    // mobile cards
    list.forEach((rpt, i) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      const itemsStr = (rpt.items || []).map(it => escapeHtml(it.name || '')).join(', ');
      tr.innerHTML = `
        <td colspan="11" class="p-2">
          <div class="p-3 bg-white rounded-xl shadow">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">#${i + 1} ‚Ä¢ ${escapeHtml(itemsStr)}</div>
                <div class="text-sm text-gray-500">${fmtDate(rpt.date)}</div>
              </div>
              <div class="text-right">
                <div class="font-semibold">${fmtMoney(rpt.amount)}</div>
                <div class="text-xs ${rpt.status === 'paid' ? 'text-emerald-600' : 'text-rose-600'}">${rpt.status}</div>
              </div>
            </div>
            <div class="mt-3 text-sm text-gray-600">
              Customer: ${escapeHtml(rpt.customer || '')}<br>
              Phone: ${escapeHtml(rpt.phone || '')}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="action-icon" data-action="print-report" data-id="${rpt.id}" title="Print"><i class="fa-solid fa-print"></i></button>
              <button class="action-icon text-red-600" data-action="delete-report" data-id="${rpt.id}" title="Delete"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </td>
      `;
      reportsRows.appendChild(tr);
    });
  } else {
    // show header again on desktop
    document.getElementById('reportsTableHead')?.classList.remove('hidden');
    document.getElementById('reportsTableWrapper')?.classList.remove('overflow-hidden');

    // desktop table rows
    list.forEach((rpt, idx) => {
      const tr = document.createElement('tr');
      const products = (rpt.items || []).map(it => escapeHtml(it.name || '')).join(', ');
      tr.innerHTML = `
        <td class="p-2">${idx + 1}</td>
        <td class="p-2">${products}</td>
        <td class="p-2">${(rpt.items || []).reduce((s,it)=>s + (Number(it.qty)||0),0)}</td>
        <td class="p-2">${fmtMoney(rpt.amount)}</td>
        <td class="p-2">${fmtMoney(rpt.paid)}</td>
        <td class="p-2">${fmtMoney(rpt.due||0)}</td>
        <td class="p-2">${escapeHtml(rpt.status)}</td>
        <td class="p-2">${escapeHtml(rpt.customer||'')}</td>
        <td class="p-2">${escapeHtml(rpt.phone||'')}</td>
        <td class="p-2">${fmtDateTime(rpt.date)}</td>
        <td class="p-2 no-print">
          <div class="flex gap-2">
            <button class="action-icon" data-action="print-report" data-id="${rpt.id}" title="Print"><i class="fa-solid fa-print"></i></button>
            <button class="action-icon text-red-600" data-action="delete-report" data-id="${rpt.id}" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </td>
      `;
      reportsRows.appendChild(tr);
    });
  }
}

// hook search input so it updates results live
reportsSearchInput?.addEventListener('input', renderReports);
reportsPeriod?.addEventListener('change', renderReports);
reportsDate?.addEventListener('change', renderReports);



  // reports actions (print/delete)
  reportsRows?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    if (action === 'delete-report') {
      if (!confirm('Delete this report?')) return;
      const arr = getAllReports();
      const idx = arr.findIndex(r => r.id === id);
      if (idx >= 0) arr.splice(idx, 1);
      saveAllReports(arr); renderReports(); toast('Report deleted', 'success');
    } else if (action === 'print-report') {
      const rpt = (getAllReports() || []).find(r => r.id === id);
      if (!rpt) return toast('Report not found', 'error');
      // prepare printable content (use header described)
      printReport(rpt);
    }
  });

  function printReport(rpt) {
    const period = (reportsPeriod?.value) || 'lifetime';
    const dateStr = (reportsDate?.value) || '';
    // header generation
    const headerLabel = generateReportHeader(period, dateStr);
    const win = window.open('', 'PRINT', 'height=800,width=1000');
    const head = `<html><head><title>Report ${escapeHtml(rpt.id)}</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}th{background:#f4f4f4}</style></head><body>`;
    const footer = `</body></html>`;
    const productsHtml = (rpt.items || []).map(it => `<tr><td>${escapeHtml(it.name||'')}</td><td>${it.qty||1}</td><td>${fmtMoney(it.total|| (it.price?it.price*it.qty:0))}</td><td>${fmtMoney(rpt.paid||0)}</td><td>${fmtMoney(rpt.due||0)}</td><td>${escapeHtml(rpt.status||'')}</td><td>${escapeHtml(rpt.customer||'')}</td><td>${escapeHtml(rpt.phone||'')}</td><td>${fmtDateTime(rpt.date)}</td></tr>`).join('');
    const content = `<h2>${escapeHtml(headerLabel)}</h2><table><thead><tr><th>Products</th><th>Qty</th><th>Total</th><th>Paid</th><th>Due</th><th>Status</th><th>Customer</th><th>Phone</th><th>Timestamp</th></tr></thead><tbody>${productsHtml}</tbody></table>`;
    win.document.write(head + content + footer);
    win.document.close();
    win.focus();
    setTimeout(()=>{ try{ win.print(); }catch(e){ toast('Print failed', 'error'); } }, 300);
  }

  // exports for reports (PDF)
  reportsExportPdf?.addEventListener('click', async () => {
    const period = (reportsPeriod?.value) || 'lifetime';
    const dateStr = (reportsDate?.value) || '';
    const search = (reportsSearchInput?.value) || '';
    const list = getReportsFiltered(period, dateStr, search);
    const headerLabel = generateReportHeader(period, dateStr);
    if (typeof window.jspdf === 'undefined') {
      // try to load
      try {
        await ensureLib('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      } catch (e) { toast('PDF export library failed to load', 'error'); return; }
    }
    try {
      const { jsPDF } = window.jspdf || window.jspdf || window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14); doc.text(headerLabel, 14, 20);
      const rows = [];
      list.forEach((rpt, idx) => {
        const products = (rpt.items || []).map(it => it.name || '').join(', ');
        const qty = (rpt.items || []).reduce((s,it)=>s+(Number(it.qty)||0),0);
        rows.push([String(idx+1), products, String(qty), fmtMoney(rpt.amount), fmtMoney(rpt.paid), fmtMoney(rpt.due||0), rpt.status || '', rpt.customer || '', rpt.phone || '', fmtDateTime(rpt.date)]);
      });
      doc.autoTable({
        head: [['#', 'Products', 'Qty','Total','Paid','Due','Status','Customer','Phone','Timestamp']],
        body: rows,
        startY: 30,
        styles: { fontSize: 8 }
      });
      doc.save(`reports_${period}_${Date.now()}.pdf`);
    } catch (e) {
      console.error(e); toast('PDF export failed', 'error');
    }
  });

  // Delete all reports - modal wiring
  reportsDeleteAll?.addEventListener('click', () => {
    const user = getCurrentUser(); if (!user) return;
    if (!confirm('Delete all reports for this store?')) return;
    let all = getAllReports();
    all = all.filter(r => String(r.store || '').toLowerCase() !== String(user.name || '').toLowerCase());
    saveAllReports(all); renderReports(); toast('All reports deleted', 'success');
  });

  function generateReportHeader(period, dateStr) {
    const dt = dateStr ? new Date(dateStr) : new Date();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    if (period === 'daily') {
      const weekday = dayNames[dt.getDay()];
      return `${weekday} / ${monthNames[dt.getMonth()]} / ${dt.getFullYear()} reports`;
    } else if (period === 'weekly') {
      // compute start/end
      const end = dt;
      const start = new Date(dt); start.setDate(dt.getDate() - 6);
      return `Week of ${fmtDate(start)} - ${fmtDate(end)} / ${monthNames[dt.getMonth()]} / ${dt.getFullYear()} reports`;
    } else if (period === 'monthly') {
      return `${monthNames[dt.getMonth()]} / ${dt.getFullYear()} reports`;
    } else if (period === 'yearly') {
      return `${dt.getFullYear()} reports`;
    }
    return `All time reports`;
  }

  /* =========================
     REMAINING UI wiring & startup
     ========================= */

  // invoice row click handlers for filtering/search already attached
  filterStatus?.addEventListener('change', renderInvoiceTable);
  searchName?.addEventListener('input', renderInvoiceTable);

  // products & reports initial render when ready
  function initAfterLoad() {
    // show/hide nav on auth screens
    const user = getCurrentUser();
    if (!user) {
      // show auth screen
      authSection && authSection.classList.remove('hidden');
      dashboardSection && dashboardSection.classList.add('hidden');
      showLoginForm();
      setAuthVisibility(true);
    } else {
      loadDashboard();
    }
    // prepare initial product rendering
    renderProductList(searchInput?.value || '');
    // prepare reports listing
    renderReports();

    // Ensure createInvoiceSection is hidden by default (already class hidden-section in HTML)
    if (createInvoiceSection && !createInvoiceSection.classList.contains('hidden')) createInvoiceSection.classList.add('hidden');

    // ensure settings cog next to store ‚Äî minimal implementation if not present
    function ensureSettingsBtn() {
      if (document.querySelector('.storeSettingsBtn')) return;
      const target = document.querySelector('#storeDisplayDesktop') || document.querySelector('.store-display') || document.querySelector('.store-name') || document.querySelector('[data-store-name]');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'storeSettingsBtn inline-flex items-center gap-2 ml-2 px-2 py-1 rounded bg-emerald-600 text-white hidden';
      btn.title = 'Settings';
      btn.innerHTML = '<i class="fas fa-cog"></i>';
      btn.addEventListener('click', () => openSettingsModal());
      if (target && target.parentNode) {
        if (target.nextSibling) target.parentNode.insertBefore(btn, target.nextSibling); else target.parentNode.appendChild(btn);
      } else {
        btn.classList.add('fixed', 'right-4', 'top-4', 'z-60');
        document.body.appendChild(btn);
      }
    }
    ensureSettingsBtn();
  }

  document.addEventListener('DOMContentLoaded', initAfterLoad);

  /* =========================
     SETTINGS modal (simple)
     ========================= */

  /* =========================
   SETTINGS COG + SETTINGS MODAL (drop-in)
   Paste in auth.js inside the same IIFE as lsGet/lsSet/getCurrentUser, etc.
   ========================= */

(function setupSettingsModule(){

  // tiny toast fallback (if your project already has toast(), this won't overwrite)
  if (typeof window.toast !== 'function') {
    window.toast = function (msg = '', type = 'info') {
      try {
        const id = 'app-toast';
        const existing = document.getElementById(id);
        if (existing) existing.remove();
        const el = document.createElement('div');
        el.id = id;
        el.textContent = msg;
        el.className = 'fixed right-4 bottom-6 z-50 p-3 rounded shadow-lg';
        el.style.background = type === 'error' ? '#fee2e2' : (type === 'success' ? '#dcfce7' : '#eef2ff');
        el.style.color = '#0f172a';
        document.body.appendChild(el);
        // fade & remove
        setTimeout(()=> el.classList.add('opacity-0'), 2000);
        setTimeout(()=> el.remove(), 2400);
      } catch(e){ console.log(msg); }
    };
  }

  // Ensure required app helpers exist
  if (typeof lsGet !== 'function' || typeof lsSet !== 'function') {
    // no-op if your app doesn't provide them; you should have them present.
    console.warn('Settings module expects lsGet/lsSet helpers (localStorage wrappers).');
  }

  // create or reuse the settings cog button
  function ensureSettingsBtn() {
    // prefer pre-existing markup (#storeSettingsBtn) or class .storeSettingsBtn
    let btn = document.getElementById('storeSettingsBtn') || document.querySelector('.storeSettingsBtn');

    if (!btn) {
      // attempt to insert next to store display
      const target = document.querySelector('#storeDisplayDesktop') || document.querySelector('.store-display') || document.querySelector('.store-name') || document.querySelector('[data-store-name]');
      btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'storeSettingsBtn';
      btn.className = 'storeSettingsBtn hidden inline-flex items-center gap-2 ml-2 px-2 py-1 rounded bg-emerald-600 text-white';
      btn.title = 'Settings';
      btn.setAttribute('aria-label', 'Open settings');
      btn.innerHTML = '<i class="fa-solid fa-cog"></i>';
      btn.style.cursor = 'pointer';
      if (target && target.parentNode) {
        try { target.insertAdjacentElement('afterend', btn); } catch (e) { target.parentNode.appendChild(btn); }
      } else {
        // fallback fixed top-right (hidden initially)
        btn.classList.add('fixed', 'right-4', 'top-4', 'z-60');
        document.body.appendChild(btn);
      }
    }

    // click opens settings modal
    btn.removeEventListener('click', settingsClickHandler); // remove previous to avoid doubles
    btn.addEventListener('click', settingsClickHandler);

    // visibility toggler
    function updateVisibility(){
      const user = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      if (!btn) return;
      if (user) btn.classList.remove('hidden'); else btn.classList.add('hidden');
    }
    // run immediately and on login/logout updates
    updateVisibility();
    window.addEventListener('dataUpdated', updateVisibility);
    // also hide on DOMContentLoaded if no user
    document.addEventListener('DOMContentLoaded', updateVisibility);

    return btn;
  }

  function settingsClickHandler(e){
    e && e.stopPropagation();
    openSettingsModal();
  }

  // builds and opens the modal (id: appSettingsModal)
  function openSettingsModal() {
    let modal = document.getElementById('appSettingsModal');
    if (!modal) {
      const fragment = document.createElement('div');
      fragment.innerHTML = `
      <div id="appSettingsModal" class="hidden fixed inset-0 z-70 flex items-start justify-center p-4">
        <div id="appSettingsModalBackdrop" class="absolute inset-0 bg-black/50"></div>
        <div class="relative w-full max-w-4xl bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-auto max-h-[90vh]">
          <div class="flex items-center justify-between p-4 border-b">
            <h2 id="settingsTitle" class="text-lg font-semibold">Settings & Utilities</h2>
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2 text-sm"><input id="settingsDarkMode" type="checkbox"> Dark</label>
              <button id="settingsCloseBtn" class="px-3 py-1 rounded bg-gray-200">Close</button>
            </div>
          </div>
          <div class="flex gap-4 p-4">
            <nav id="settingsNav" class="w-56">
              <ul class="space-y-2">
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="lang">Language</button></li>
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="user">Edit User</button></li>
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="messages">Messages</button></li>
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="notices">Notices</button></li>
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="help">Help</button></li>
                <li><button class="settings-tab w-full text-left px-3 py-2 rounded" data-tab="export">Export</button></li>
              </ul>
            </nav>
            <div class="flex-1" id="settingsContent">
              <div class="settings-panel hidden" data-panel="lang">
                <h3 class="font-semibold mb-2">Language</h3>
                <div class="flex gap-2 items-center mb-4">
                  <select id="settingsLangSelect" class="border rounded px-3 py-2">
                    <option value="en">English</option>
                    <option value="so">Somali</option>
                  </select>
                  <button id="saveLangBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
              </div>

              <div class="settings-panel hidden" data-panel="user">
                <h3 class="font-semibold mb-2">Edit User</h3>
                <form id="settingsEditUserForm" class="space-y-2 p-2">
                  <div><label class="block text-sm">Supermarket Name</label><input id="settingsUserName" class="border rounded px-2 py-1 w-full"></div>
                  <div><label class="block text-sm">Phone</label><input id="settingsUserPhone" class="border rounded px-2 py-1 w-full"></div>
                  <div><label class="block text-sm">Address</label><input id="settingsUserAddress" class="border rounded px-2 py-1 w-full"></div>
                  <div><label class="block text-sm">Email</label><input id="settingsUserEmail" class="border rounded px-2 py-1 w-full"></div>
                  <div class="grid grid-cols-2 gap-2">
                    <div><label class="block text-sm">Password</label><input id="settingsUserPassword" type="password" class="border rounded px-2 py-1 w-full"></div>
                    <div><label class="block text-sm">Confirm</label><input id="settingsUserPasswordConfirm" type="password" class="border rounded px-2 py-1 w-full"></div>
                  </div>
                  <div class="flex gap-2">
                    <button id="settingsSaveUserBtn" class="px-3 py-2 bg-emerald-600 text-white rounded">Save Changes</button>
                    <button id="settingsCancelUserBtn" type="button" class="px-3 py-2 bg-gray-200 rounded">Cancel</button>
                  </div>
                  <div id="settingsUserMsg" class="text-sm text-red-600 hidden"></div>
                </form>
              </div>

              <div class="settings-panel hidden" data-panel="messages">
                <h3 class="font-semibold mb-2">WhatsApp / SMS Templates</h3>
                <p class="text-sm mb-2">Use placeholders: <code>{customer}</code>, <code>{id}</code>, <code>{balance}</code>, <code>{store}</code>, <code>{phone}</code></p>
                <div class="space-y-2 p-2">
                  <div>
                    <label class="block text-sm">WhatsApp Template</label>
                    <textarea id="settingsWaTpl" rows="3" class="w-full border rounded p-2"></textarea>
                  </div>
                  <div>
                    <label class="block text-sm">SMS Template</label>
                    <textarea id="settingsSmsTpl" rows="3" class="w-full border rounded p-2"></textarea>
                  </div>
                  <div class="flex gap-2">
                    <button id="settingsSaveMsgBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
                    <button id="settingsResetMsgBtn" class="px-3 py-2 bg-gray-200 rounded">Reset Defaults</button>
                  </div>
                  <div id="settingsMsgStatus" class="text-sm text-green-600 hidden"></div>
                </div>
              </div>

              <div class="settings-panel hidden" data-panel="notices">
                <h3 class="font-semibold mb-2">Notices</h3>
                <div class="mb-2">
                  <button id="settingsAddNoticeBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Add Notice</button>
                  <button id="settingsSeedNoticesBtn" class="px-3 py-2 bg-gray-200 rounded">Seed Defaults</button>
                </div>
                <div id="settingsNoticesList" class="space-y-2 max-h-64 overflow-auto p-2"></div>
              </div>

              <div class="settings-panel hidden" data-panel="help">
                <h3 class="font-semibold mb-2">Help & Guidance</h3>
                <div class="prose max-w-none p-2">
                  <h4>Invoices</h4>
                  <ul>
                    <li>To create an invoice, open the invoice form and add items (name & price). Save to add it to the list.</li>
                    <li>Mark as paid/unpaid using the toggle button on each invoice row.</li>
                    <li>Use the action icons to call, WhatsApp, SMS, print, or share an invoice card.</li>
                  </ul>
                </div>
              </div>

              <div class="settings-panel hidden" data-panel="export">
                <h3 class="font-semibold mb-2">Export / Download</h3>
                <p class="text-sm mb-2">Download invoices as JSON or CSV (local data).</p>
                <div class="flex gap-2 mb-4 p-2">
                  <button id="exportInvoicesJson" class="px-3 py-2 bg-blue-600 text-white rounded">Download JSON</button>
                  <button id="exportInvoicesCsv" class="px-3 py-2 bg-gray-700 text-white rounded">Download CSV</button>
                </div>
                <div id="settingsExportMsg" class="text-sm text-green-600 hidden"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
      `;
      document.body.appendChild(fragment);
      modal = document.getElementById('appSettingsModal');

      // wire tabs
      modal.querySelectorAll('.settings-tab').forEach(tb => {
        tb.addEventListener('click', () => {
          const name = tb.dataset.tab;
          modal.querySelectorAll('.settings-panel').forEach(p => {
            if (p.dataset.panel === name) p.classList.remove('hidden'); else p.classList.add('hidden');
          });
          modal.querySelectorAll('.settings-tab').forEach(tt => tt.classList.toggle('bg-gray-100', tt === tb));
        });
      });

      // close/backdrop
      modal.querySelector('#settingsCloseBtn')?.addEventListener('click', () => modal.classList.add('hidden'));
      modal.addEventListener('click', (e) => { if (e.target === modal || e.target.id === 'appSettingsModalBackdrop') modal.classList.add('hidden'); });

      // dark toggle
      modal.querySelector('#settingsDarkMode')?.addEventListener('change', (e) => {
        const on = !!e.target.checked; lsSet && lsSet(LS_DARK, on);
        if (on) document.body.classList.add('dark'); else document.body.classList.remove('dark');
        toast('Dark mode updated','success');
      });

      // language save
      modal.querySelector('#saveLangBtn')?.addEventListener('click', () => {
        const sel = document.getElementById('settingsLangSelect');
        if (!sel) return;
        lsSet && lsSet(LS_APP_LANG, sel.value || 'en');
        applyLanguage && applyLanguage(sel.value || 'en');
        toast('Language saved','success');
      });

      // settings user save
      modal.querySelector('#settingsSaveUserBtn')?.addEventListener('click', (ev) => {
        ev.preventDefault();
        const msgEl = document.getElementById('settingsUserMsg');
        msgEl.classList.add('hidden'); msgEl.textContent = '';
        const name = document.getElementById('settingsUserName').value.trim();
        const phone = document.getElementById('settingsUserPhone').value.trim();
        const address = document.getElementById('settingsUserAddress').value.trim();
        const email = document.getElementById('settingsUserEmail').value.trim();
        const pass = document.getElementById('settingsUserPassword').value;
        const pass2 = document.getElementById('settingsUserPasswordConfirm').value;
        if (!name || !phone || !address || !email) { msgEl.textContent='All fields required'; msgEl.classList.remove('hidden'); return; }
        if (pass || pass2) { if (pass !== pass2) { msgEl.textContent='Passwords do not match'; msgEl.classList.remove('hidden'); return; } if (pass.length < 4) { msgEl.textContent='Password too short'; msgEl.classList.remove('hidden'); return; } }
        const users = (typeof getUsers==='function') ? getUsers() : [];
        const current = (typeof getCurrentUser==='function') ? getCurrentUser() : null;
        if (!current) { msgEl.textContent='No logged-in user'; msgEl.classList.remove('hidden'); return; }
        const idx = users.findIndex(u => String(u.name||'').toLowerCase() === String(current.name||'').toLowerCase());
        const newUser = { ...current, name, phone, address, email }; if (pass) newUser.password = pass;
        if (idx >= 0) users[idx] = newUser; else users.push(newUser);
        saveUsers && saveUsers(users);
        setCurrentUser && setCurrentUser(newUser);
        document.getElementById('storeDisplayDesktop') && (document.getElementById('storeDisplayDesktop').textContent = newUser.name);
        msgEl.textContent='Saved.'; msgEl.classList.remove('hidden'); msgEl.style.color='green';
        toast('User settings saved','success');
        setTimeout(()=>{ msgEl.classList.add('hidden'); msgEl.style.color=''; }, 1500);
      });

      // cancel user changes -> reload fields
      modal.querySelector('#settingsCancelUserBtn')?.addEventListener('click', () => {
        const current = (typeof getCurrentUser==='function') ? getCurrentUser() : {};
        document.getElementById('settingsUserName') && (document.getElementById('settingsUserName').value = current.name || '');
        document.getElementById('settingsUserPhone') && (document.getElementById('settingsUserPhone').value = current.phone || '');
        document.getElementById('settingsUserAddress') && (document.getElementById('settingsUserAddress').value = current.address || '');
        document.getElementById('settingsUserEmail') && (document.getElementById('settingsUserEmail').value = current.email || '');
      });

      // messages save/reset
      modal.querySelector('#settingsSaveMsgBtn')?.addEventListener('click', () => {
        const wa = document.getElementById('settingsWaTpl').value.trim();
        const sms = document.getElementById('settingsSmsTpl').value.trim();
        lsSet && lsSet(LS_MSG_TPL, { reminder_wa: wa, reminder_sms: sms });
        const s = document.getElementById('settingsMsgStatus'); if (s) { s.textContent='Saved'; s.classList.remove('hidden'); setTimeout(()=>s.classList.add('hidden'),1400); }
        toast('Templates saved','success');
      });
      modal.querySelector('#settingsResetMsgBtn')?.addEventListener('click', () => {
        if (!confirm('Reset message templates to defaults?')) return;
        lsSet && lsSet(LS_MSG_TPL, {
          reminder_wa: "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}. Fadlan iska bixi dukaanka {store} ({phone}).",
          reminder_sms: "Xasuusin: {customer}, lacagta lagugu leeyahay waa: {balance}. Fadlan iska bixi dukaanka {store} ({phone})."
        });
        toast('Templates reset','success');
      });

      // notices
      function renderNoticesList(){
        const listEl = document.getElementById('settingsNoticesList');
        if (!listEl) return;
        const notices = lsGet ? lsGet(LS_NOTICES) || [] : [];
        listEl.innerHTML = '';
        notices.forEach(n=>{
          const div = document.createElement('div'); div.className='p-2 border rounded';
          div.innerHTML = `<div class="flex justify-between items-start"><div><strong>${escapeHtml(n.title)}</strong><div class="text-sm text-gray-600">${new Date(n.created).toLocaleString()}</div></div><div class="flex gap-1"><button class="notice-edit px-2 py-1 bg-yellow-400 text-white rounded" data-id="${n.id}">Edit</button><button class="notice-del px-2 py-1 bg-red-600 text-white rounded" data-id="${n.id}">Del</button></div></div><div class="mt-2 text-sm">${escapeHtml(n.body)}</div>`;
          listEl.appendChild(div);
        });
        // wire actions
        listEl.querySelectorAll('.notice-del').forEach(b=>b.addEventListener('click', ()=> {
          const id = b.dataset.id; if (!confirm('Delete notice?')) return;
          let arr = lsGet ? lsGet(LS_NOTICES) || [] : [];
          arr = arr.filter(x=>x.id !== id); lsSet && lsSet(LS_NOTICES, arr); renderNoticesList();
        }));
        listEl.querySelectorAll('.notice-edit').forEach(b=>b.addEventListener('click', ()=> {
          const id = b.dataset.id; const arr = lsGet ? lsGet(LS_NOTICES) || [] : []; const found = arr.find(x=>x.id===id); if (!found){ toast('Notice not found','error'); return;}
          const title = prompt('Title', found.title); if (title === null) return; const body = prompt('Body', found.body); if (body === null) return;
          found.title = title; found.body = body; lsSet && lsSet(LS_NOTICES, arr); renderNoticesList(); toast('Notice updated','success');
        }));
      }
      modal.querySelector('#settingsAddNoticeBtn')?.addEventListener('click', ()=> {
        const title = prompt('Notice title'); if (!title) return; const body = prompt('Notice body') || '';
        const notices = lsGet ? lsGet(LS_NOTICES) || [] : []; notices.unshift({ id:`N-${Date.now()}`, title, body, pinned:false, created:Date.now() });
        lsSet && lsSet(LS_NOTICES, notices); renderNoticesList(); toast('Notice added','success');
      });
      modal.querySelector('#settingsSeedNoticesBtn')?.addEventListener('click', ()=> {
        if (!confirm('Seed sample notices?')) return; const seed=[{ id:`N-${Date.now()}-1`, title:'Tip', body:'Use export to backup invoices.', pinned:false, created:Date.now()}];
        const arr = (lsGet? lsGet(LS_NOTICES)||[] : []).concat(seed); lsSet && lsSet(LS_NOTICES, arr); renderNoticesList(); toast('Notices seeded','success');
      });

      // exports
      modal.querySelector('#exportInvoicesJson')?.addEventListener('click', ()=> {
        const user = (typeof getCurrentUser==='function')? getCurrentUser():null; if (!user) { toast('Login required','error'); return; }
        const inv = (typeof getStoreInvoices==='function')? getStoreInvoices(user.name) : [];
        const blob = new Blob([JSON.stringify(inv, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoices_${user.name}_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); toast('Invoices JSON exported','success');
      });
      modal.querySelector('#exportInvoicesCsv')?.addEventListener('click', ()=> {
        const user = (typeof getCurrentUser==='function')? getCurrentUser():null; if (!user) { toast('Login required','error'); return; }
        const inv = (typeof getStoreInvoices==='function')? getStoreInvoices(user.name) : [];
        const rows=[['id','date','customer','phone','amount','paid','status','items']];
        inv.forEach(i=> rows.push([i.id,i.date,`"${(i.customer||'').replace(/"/g,'""')}"`, i.phone,i.amount,i.paid,i.status,`"${(i.items||[]).map(it=>it.name).join('|')}"`]));
        const csv = rows.map(r=> r.map(c=>String(c).replace(/\n/g,' ')).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoices_${user.name}_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); toast('Invoices CSV exported','success');
      });

      // initial notices render
      renderNoticesList();

    } // end modal creation

    // populate fields and show modal
    modal.classList.remove('hidden');
    const langSelect = document.getElementById('settingsLangSelect');
    if (langSelect) langSelect.value = lsGet ? (lsGet(LS_APP_LANG) || 'en') : 'en';
    const current = (typeof getCurrentUser==='function') ? getCurrentUser() : {};
    document.getElementById('settingsUserName') && (document.getElementById('settingsUserName').value = current.name || '');
    document.getElementById('settingsUserPhone') && (document.getElementById('settingsUserPhone').value = current.phone || '');
    document.getElementById('settingsUserAddress') && (document.getElementById('settingsUserAddress').value = current.address || '');
    document.getElementById('settingsUserEmail') && (document.getElementById('settingsUserEmail').value = current.email || '');
    const tpl = lsGet ? (lsGet(LS_MSG_TPL) || {}) : {};
    document.getElementById('settingsWaTpl') && (document.getElementById('settingsWaTpl').value = tpl.reminder_wa || '');
    document.getElementById('settingsSmsTpl') && (document.getElementById('settingsSmsTpl').value = tpl.reminder_sms || '');
    const dark = lsGet ? lsGet(LS_DARK) : false;
    const darkToggle = document.getElementById('settingsDarkMode');
    if (dark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
    if (darkToggle) darkToggle.checked = !!dark;
    // default panel = user
    modal.querySelectorAll('.settings-panel').forEach(p => p.dataset.panel === 'user' ? p.classList.remove('hidden') : p.classList.add('hidden'));
  } // end openSettingsModal

  // expose a small global AppSettings helper
  window.AppSettings = window.AppSettings || {};
  window.AppSettings.open = openSettingsModal;
  window.AppSettings.close = function(){ const m=document.getElementById('appSettingsModal'); if (m) m.classList.add('hidden'); };
  window.AppSettings.ensure = ensureSettingsBtn;
  window.AppSettings.createStoreSettingsBtn = function(){ const b = ensureSettingsBtn(); if (b) b.classList.remove('hidden'); };

  // Ensure a button exists right away (hidden until login)
  ensureSettingsBtn();

  // Hide settings on logout - keep in sync
  if (typeof logoutBtn !== 'undefined' && logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      setTimeout(()=>{
        const b = document.getElementById('storeSettingsBtn') || document.querySelector('.storeSettingsBtn');
        if (b) b.classList.add('hidden');
      }, 40);
    });
  }

  // Wrap loadDashboard if exists, to show button after login
  if (typeof window.loadDashboard === 'function') {
    const _orig = window.loadDashboard;
    window.loadDashboard = function(){
      try { _orig(); } finally {
        setTimeout(()=> {
          const b = document.getElementById('storeSettingsBtn') || document.querySelector('.storeSettingsBtn');
          if (b) b.classList.remove('hidden');
        }, 120);
      }
    };
  }

})(); // end settings module

  // // expose
  // window.AppSettings = {
  //   open: openSettingsModal,
  //   close: () => { const m = document.getElementById('appSettingsModal'); if (m) m.classList.add('hidden'); },
  //   getTemplates: () => lsGet(LS_MSG_TPL),
  //   getNotices: () => lsGet(LS_NOTICES),
  //   applyLanguage: (lang) => { lsSet(LS_APP_LANG, lang); applyLanguage(lang); },
  //   createStoreSettingsBtn: function () {
  //     const btn = document.querySelector('.storeSettingsBtn');
  //     if (btn) btn.classList.remove('hidden');
  //   }
  // };

  /* Expose small debug helper (optional) */
  window._supermarket_helpers = {
    lsGet, lsSet, getAllProducts, getAllInvoices, getAllReports
  };

})(); // end auth.js

</script>
</body>
</html>
