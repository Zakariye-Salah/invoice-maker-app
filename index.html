<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-KtH6cL3sV+2F/..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    @media print { .no-print { display: none !important; } }
    .hidden-section { display: none; }
    .modal-bg { display: none; background: rgba(0,0,0,0.5); position: fixed; inset: 0; justify-content: center; align-items: center; z-index: 50; }


    /* Table-ka mobile friendly */
@media (max-width: 640px) {
  table {
    width: 100%;
    font-size: 14px; /* yarayn font-ka si u fit gareeyo */
  }

  th, td {
    display: block;       /* Block-ka si uu u noqdo vertical */
    width: 100%;
    box-sizing: border-box;
    text-align: left;
  }

  thead {
    display: none;        /* Hide header on small screens */
  }

  tr {
    margin-bottom: 12px;
    border-bottom: 1px solid #ddd;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    display: block;
    margin-bottom: 4px;
  }

  .row {
    flex-direction: column;
  }

  .right {
    text-align: left;
    margin-top: 8px;
  }
}
@media (max-width: 640px) {
  .row {
    flex-direction: column;
    gap: 8px;
  }
}

  /* Mobile-friendly table stacking on very small screens */
  @media (max-width: 480px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      padding: 0.5rem;
      border-radius: 0.5rem;
    }
    td {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0.5rem;
      border: none;
    }
    td::before {
      content: attr(data-label);
      font-weight: bold;
    }
    .no-print {
      display: flex; /* keep buttons visible */
      flex-wrap: wrap;
      gap: 0.25rem;
    }
  }



  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">

 

    <header class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sm:gap-0">
      <!-- Title -->
      <h1 class="text-2xl font-bold flex items-center gap-2 text-blue-700">
        <span>ðŸ§¾</span> Invoice Maker
      </h1>
    
      <!-- Actions -->
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <!-- Language -->
        <button id="langBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow transition-all duration-200">
          ENG
        </button>
    
        <!-- Export -->
        <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow transition-all duration-200">
          Export Invoices
        </button>
    
        <!-- Login/Edit User -->
        <button id="loginbtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow relative transition-all duration-200">
          Login
        </button>
    
        <!-- Store Label -->
        <span id="storeDisplay" class="font-semibold text-gray-700 px-2 py-1 bg-gray-100 rounded shadow inline-block"></span>

      </div>
    </header>
    
    

<!-- ========== LOGIN / EDIT SUPERMARKET MODAL ========== -->
<div id="loginModal" class="modal-bg hidden">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
    <h2 id="modalTitle" class="text-lg font-bold mb-4">Supermarket Login</h2>
    <label class="block mb-2">
      <span class="text-sm">Supermarket Name *</span>
      <input id="supermarketName" class="mt-1 w-full border px-3 py-2 rounded-xl" placeholder="e.g. Kowthar Supermarket" required />
    </label>
    <label class="block mb-2">
      <span class="text-sm">Supermarket Address</span>
      <input id="supermarketAddress" class="mt-1 w-full border px-3 py-2 rounded-xl" placeholder="e.g. Hamarweyne, Mogadishu" />
    </label>
    <label class="block mb-2">
      <span class="text-sm">Supermarket Gmail</span>
      <input id="supermarketGmail" type="email" class="mt-1 w-full border px-3 py-2 rounded-xl" placeholder="e.g. example@gmail.com" />
    </label>
    <label class="block mb-2">
      <span class="text-sm">Supermarket Phone</span>
      <input id="supermarketPhone" class="mt-1 w-full border px-3 py-2 rounded-xl" placeholder="e.g. 617XXXXXX" />
    </label>
    <label class="block mb-4">
      <span class="text-sm">Country Code</span>
      <input id="countryCode" class="mt-1 w-full border px-3 py-2 rounded-xl" placeholder="+252" value="+252" />
    </label>

    <div class="flex justify-end gap-2">
      <button id="cancelLogin" class="px-4 py-2 rounded-xl bg-gray-400 hover:bg-gray-500 text-white">Cancel</button>
      <button id="saveLogin" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white">Save</button>
    </div>
  </div>
</div>
 
    <!-- CREATE INVOICE BUTTON -->
    <div class="mb-4 flex items-center justify-between flex-wrap gap-2">
      <!-- Create Invoice Button -->
      <button id="createInvoiceBtn" 
              class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 shadow transition-all duration-200 flex items-center gap-2 no-print">
        âž• Create Invoice
      </button>
    
      <!-- Current Time Display -->
      <span id="currentTime" class="text-sm text-red-500 font-semibold">
        <!-- JS will update time here -->
      </span>
    
     
    </div>
    




    <!-- CREATE INVOICE FORM -->
    <section id="createInvoiceSection" class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6 hidden-section">
      <input type="hidden" id="editingInvoiceId" />

      <h2 class="text-lg font-semibold mb-3">Create Invoice</h2>
    
      <!-- Customer Info -->
      <div class="grid sm:grid-cols-5 gap-3 mb-4">
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Name</span>
          <input id="customerName" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. Ali Mohamed" />
        </label>
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Phone</span>
          <input id="customerPhone" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. 617XXXXXX" />
        </label>
        <label class="block">
          <span class="text-sm">Invoice Date</span>
          <input id="invoiceDate" type="date" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </label>
      </div>
    
      <!-- Invoice Items -->
      <div id="invoiceItemsContainer" class="mb-3">
        <!-- Item rows will appear here -->
      </div>
      <button id="addItemBtn" class="mb-3 inline-block rounded-xl bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">+ Add Item</button>
    
      <div class="grid sm:grid-cols-2 gap-3 mb-3">
        <label>
          <span class="text-sm">Total Amount</span>
          <input id="amount" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" readonly />
        </label>
        <label>
          <span class="text-sm">Amount Paid</span>
          <input id="paid" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" />
        </label>
        <label>
          <span class="text-sm">Status</span>
          <select id="status" class="mt-1 w-full rounded-xl border px-3 py-2">
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
        </label>
      </div>
    
      <button id="saveInvoiceBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 w-full">Save Invoice</button>
      <p id="formMsg" class="hidden mt-3 text-red-600 text-sm"></p>
    </section>
    
<!-- INVOICES LIST -->
<section class="bg-white rounded-2xl shadow p-4 sm:p-6">
<!-- Header: Title + Filters + Buttons -->
<div class="flex flex-wrap items-center justify-between gap-2 mb-3">
  <h2 id="invoicesTitle" class="text-lg font-semibold mr-3">Invoices</h2>

  <div class="flex flex-wrap items-center gap-2 flex-1 min-w-[250px]">
    <button id="clearPaidBtn" class="bg-red-600 text-white px-3 py-2 rounded whitespace-nowrap">Clear Paid</button>

    <select id="filterStatus" class="rounded-xl border px-3 py-2 whitespace-nowrap">
      <option value="all">All</option>
      <option value="paid">Paid</option>
      <option value="unpaid">Unpaid</option>
    </select>

    <input id="searchName" class="rounded-xl border px-3 py-2 flex-1 min-w-[120px]" placeholder="Search by name..." />
  </div>
</div>

<!-- Reminder Buttons -->
<div class="flex flex-wrap items-center gap-2 mb-4">
  <select id="reminderMethod" class="border rounded px-2 py-1 whitespace-nowrap">
    <option value="wa">WhatsApp</option>
    <option value="sms">SMS</option>
  </select>
  <button id="sendAllReminders" class="bg-purple-600 text-white px-3 py-2 rounded whitespace-nowrap">
    Send All Reminders
  </button>
</div>

<div class="overflow-x-auto">
    <table class="w-full text-left border-collapse">
      <thead class="hidden sm:table-header-group">
        <tr>
          <th class="p-2 font-medium text-blue-600">No</th>
          <th class="p-2 font-medium text-blue-600">Invoice</th>
          <th class="p-2 font-medium text-blue-600">Date</th>
          <th class="p-2 font-medium text-blue-600">Customer</th>
          <th class="p-2 font-medium text-blue-600">Phone</th>
          <th class="p-2 font-medium text-blue-600 text-right">Amount</th>
          <th class="p-2 font-medium text-blue-600 text-right">Paid</th>
          <th class="p-2 font-medium text-blue-600 text-right">Balance</th>
          <th class="p-2 font-medium text-blue-600">Status</th>
          <th class="p-2 font-medium text-blue-600 no-print">Actions</th>
        </tr>
      </thead>
      <tbody id="invoiceRows" class="block sm:table-row-group"></tbody>
    </table>
  </div>
</section>

   
      

      <p id="emptyState" class="hidden text-center text-gray-500 py-6">No invoices yet.</p>
    </section>
  </div>


  <!-- Footer -->
<footer class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 px-6 py-6 mt-8 border-t border-gray-300 dark:border-gray-700">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">

    <!-- Left: Copyright -->
    <div class="text-sm text-gray-600 dark:text-gray-400">
      &copy; 2025 <span class="font-semibold">Zakariye</span>. All rights reserved.
    </div>

    <!-- Right: Social links -->
    <div class="flex gap-4 items-center">

      <!-- Gmail -->
      <a href="mailto:engzaki410@gmail.com" target="_blank" class="hover:text-red-600 transition-colors" title="Email">
        <i class="fa-solid fa-envelope fa-lg"></i>
      </a>

      <!-- WhatsApp -->
      <a href="https://wa.me/252617125558" target="_blank" class="hover:text-green-500 transition-colors" title="WhatsApp">
        <i class="fa-brands fa-whatsapp fa-lg"></i>
      </a>

      <!-- Facebook -->
      <a href="https://www.facebook.com/share/19ayTrQCzP/" target="_blank" class="hover:text-blue-800 transition-colors" title="Facebook">
        <i class="fa-brands fa-facebook fa-lg"></i>
      </a>

      <!-- GitHub -->
      <a href="https://github.com/Zakariye-Salah/" target="_blank" class="hover:text-gray-900 dark:hover:text-white transition-colors" title="GitHub">
        <i class="fa-brands fa-github fa-lg"></i>
      </a>

    </div>
  </div>
</footer>



<!-- Add jsPDF library (add in your HTML <head> or before your script) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// -------------------- LANGUAGE SETUP -------------------- //
// Default: Somali if first time
let currentLang = localStorage.getItem("lang") || "som";
localStorage.setItem("lang", currentLang);

// Update button label
const langBtnEl = document.getElementById("langBtn");
if (langBtnEl) langBtnEl.innerText = currentLang === "eng" ? "ENG" : "SOM";

// Helper
function t(key) {
  return translations[currentLang]?.[key] || key;
}

// -------------------- TRANSLATIONS -------------------- //
const translations = {
  som: {
    searchPlaceholder: "Raadi Macmiil ama Invoice",
    filterAll: "Dhammaan",
    filterPaid: "Bixiyay",
    filterUnpaid: "Bixinin",
    emptyState: "Ma jiraan invoices la helay",
    createInvoice: "Samee Invoice",
    customerName: "Magaca Macmiilka",
    customerPhone: "Telefoonka Macmiilka",
    invoiceDate: "Taariikhda Invoice",
    totalAmount: "Wadarta Lacagta",
    amountPaid: "Lacagta La Bixiyay",
    status: "Xaaladda",
    no: "No",
    invoice: "Invoice",
    date: "Taariikh",
    customer: "Macmiil",
    phone: "Telefoon",
    amount: "Tiro",
    paidBtn: "Bixiyay",
    unpaidBtn: "Bixinin",
    addItem: "+ Ku dar Shay",
    description: "Sheyga lagatay",
    balance: "Hadhaaga",
    actions: "Hawlaha",
    exportInvoices: "Degso Invoices",
    login: "Gali",
    editUser: "Beddel Isticmaalaha",
    clearPaid: "Tirtir bixiyaasha",
    sendAllReminders: "Dir Dhammaan Xasuusinta",
    invoicesTitle: "Biilal",
    storeLabel: "Dukaan: {name}"
  },
  eng: {
    searchPlaceholder: "Search Customer or Invoice",
    filterAll: "All",
    filterPaid: "Paid",
    filterUnpaid: "Unpaid",
    emptyState: "No invoices found",
    createInvoice: "Create Invoice",
    customerName: "Customer Name",
    customerPhone: "Customer Phone",
    invoiceDate: "Invoice Date",
    totalAmount: "Total Amount",
    amountPaid: "Amount Paid",
    status: "Status",
    no: "No",
    invoice: "Invoice",
    date: "Date",
    customer: "Customer",
    phone: "Phone",
    amount: "Amount",
    paidBtn: "Paid",
    unpaidBtn: "Unpaid",
    addItem: "+ Add Item",
    description: "Description",
    balance: "Balance",
    actions: "Actions",
    exportInvoices: "Export Invoices",
    login: "Login",
    editUser: "Edit User",
    clearPaid: "Clear Paid",
    sendAllReminders: "Send All Reminders",
    invoicesTitle: "Invoices",
    storeLabel: "Store: {name}"
  }
};

// -------------------- STORE & LOGIN -------------------- //
function updateStoreName(storeName) {
  const label = t("storeLabel").replace("{name}", storeName);
  const storeEl = document.getElementById("storeDisplay");
  if (storeEl) storeEl.innerText = label;
}

function updateLoginButton() {
  const loginBtn = document.getElementById("loginbtn");
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if (loginBtn) loginBtn.innerText = user ? t("editUser") : t("login");
}

// -------------------- UI UPDATES -------------------- //
function updateTableHeaders() {
  const headers = document.querySelectorAll("table thead th");
  if (!headers || headers.length < 10) return;
  headers[0].innerText = t("no");
  headers[1].innerText = t("invoice");
  headers[2].innerText = t("date");
  headers[3].innerText = t("customer");
  headers[4].innerText = t("phone");
  headers[5].innerText = t("amount");
  headers[6].innerText = t("paid");
  headers[7].innerText = t("balance");
  headers[8].innerText = t("status");
  headers[9].innerText = t("actions");
}

function updateButtonsAndTitles() {
  const createBtn = document.getElementById("createInvoiceBtn");
  if (createBtn) createBtn.innerText = t("createInvoice");

  const exportBtn = document.getElementById("exportBtn");
  if (exportBtn) exportBtn.innerText = t("exportInvoices");

  const loginBtn = document.getElementById("loginbtn");
  if (loginBtn) updateLoginButton();

  const clearPaidBtn = document.getElementById("clearPaidBtn");
  if (clearPaidBtn) clearPaidBtn.innerText = t("clearPaid");

  const sendAllBtn = document.getElementById("sendAllReminders");
  if (sendAllBtn) sendAllBtn.innerText = t("sendAllReminders");

  const invoicesTitle = document.getElementById("invoicesTitle");
  if (invoicesTitle) invoicesTitle.innerText = t("invoicesTitle");
}

// -------------------- OTHER TEXTS -------------------- //
function updateOtherTexts() {
  const searchInput = document.getElementById("searchName");
  if (searchInput) searchInput.placeholder = t("searchPlaceholder");

  const filter = document.getElementById("filterStatus");
  if (filter && filter.options.length >= 3) {
    filter.options[0].text = t("filterAll");
    filter.options[1].text = t("filterPaid");
    filter.options[2].text = t("filterUnpaid");
  }

  const empty = document.getElementById("emptyState");
  if (empty) empty.innerText = t("emptyState");

  const customerNameInput = document.getElementById("customerName");
  if (customerNameInput) customerNameInput.placeholder = t("customerName");

  const customerPhoneInput = document.getElementById("customerPhone");
  if (customerPhoneInput) customerPhoneInput.placeholder = t("customerPhone");

  const invoiceDateInput = document.getElementById("invoiceDate");
  if (invoiceDateInput) invoiceDateInput.placeholder = t("invoiceDate");

  const amountInput = document.getElementById("amount");
  if (amountInput) amountInput.placeholder = t("totalAmount");

  const paidInput = document.getElementById("paid");
  if (paidInput) paidInput.placeholder = t("amountPaid");

  const statusSelect = document.getElementById("status");
  if (statusSelect) {
    for (const opt of statusSelect.options) {
      if (opt.value === "paid") opt.text = t("filterPaid");
      if (opt.value === "unpaid") opt.text = t("filterUnpaid");
    }
  }
}

// -------------------- APPLY ALL -------------------- //
function applyTranslations() {
  updateOtherTexts();
  updateTableHeaders();
  updateButtonsAndTitles();
  if (typeof renderInvoices === "function") renderInvoices();
  updateStoreName("Xaliye Shop"); // âœ… dynamically set store name
  updateLoginButton(); // âœ… login/edit translated
}

// -------------------- EVENTS -------------------- //
if (langBtnEl) {
  langBtnEl.addEventListener("click", () => {
    currentLang = currentLang === "som" ? "eng" : "som";
    localStorage.setItem("lang", currentLang);
    langBtnEl.innerText = currentLang === "eng" ? "ENG" : "SOM";
    applyTranslations();
  });
}

window.addEventListener("DOMContentLoaded", () => {
  applyTranslations();
});


//////////////////
  const LS_CURRENT_USER = 'currentUser';
  const LS_INVOICES = 'invoices_v1';
  
  window.LS_KEYS = { SETTINGS: 'invoice_settings_v1', INVOICES: 'invoices_v1' };

  

  let invoices = JSON.parse(localStorage.getItem(LS_INVOICES)) || [];
  
  
  const $ = id => document.getElementById(id);
  const fmt = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const todayISO = () => new Date().toISOString().slice(0,10);
  const genInvoiceNumber = () => {
    const d = new Date(); const pad = x=>String(x).padStart(2,'0');
    return `INV-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.floor(Math.random()*1000)}`;
  };
 
  const createInvoiceBtn = document.getElementById("createInvoiceBtn");
const createInvoiceSection = document.getElementById("createInvoiceSection");

// Show the create invoice form
createInvoiceBtn.addEventListener("click", () => {
createInvoiceSection.classList.toggle("hidden-section");
});




  // Load invoices
  function load() {
    $('storeDisplay').textContent = `Store: ${currentUser.supermarketName}`;
    invoices = JSON.parse(localStorage.getItem(LS_INVOICES) || '[]');
    $('invoiceDate').value = todayISO();
    renderInvoices();
  }
  
  let currentUser = JSON.parse(localStorage.getItem(LS_CURRENT_USER)) || null;

const loginBtn = $("loginbtn");
const loginModal = $("loginModal");
const modalTitle = $("modalTitle");

// Open modal
loginBtn.addEventListener("click", () => { 
  loginModal.classList.remove('hidden'); // show modal
  loginModal.classList.add('flex');      // apply flex

  if(currentUser){
    modalTitle.textContent = "Edit Supermarket Details";
    $("supermarketName").value = currentUser.supermarketName || "";
    $("supermarketAddress").value = currentUser.supermarketAddress || "";
    $("supermarketGmail").value = currentUser.supermarketGmail || "";
    $("supermarketPhone").value = currentUser.supermarketPhone || "";
    $("countryCode").value = currentUser.countryCode || "+252";
  } else {
    modalTitle.textContent = "Supermarket Login";
    $("supermarketName").value = "";
    $("supermarketAddress").value = "";
    $("supermarketGmail").value = "";
    $("supermarketPhone").value = "";
    $("countryCode").value = "+252";
  }
});


// Cancel
$("cancelLogin").addEventListener("click", () => {
  loginModal.classList.add('hidden');    // hide modal
loginModal.classList.remove('flex');   // remove flex
});

// Save supermarket info
$("saveLogin").addEventListener("click", () => {
  const supermarketName = $("supermarketName").value.trim();
  const supermarketAddress = $("supermarketAddress").value.trim();
  const supermarketGmail = $("supermarketGmail").value.trim();
  const supermarketPhone = $("supermarketPhone").value.trim();
  const countryCode = $("countryCode").value.trim() || "+252";

  if(!supermarketName){
    alert("Supermarket name is required!");
    return;
  }

  currentUser = { supermarketName, supermarketAddress, supermarketGmail, supermarketPhone, countryCode };
  localStorage.setItem(LS_CURRENT_USER, JSON.stringify(currentUser));

  $("storeDisplay").textContent = `Store: ${currentUser.supermarketName}`;
  loginBtn.textContent = "Edit User";
  loginModal.classList.add('hidden');    // hide modal
  loginModal.classList.remove('flex');   // remove flex


  load();
});

// Auto load supermarket info if logged in
window.addEventListener("DOMContentLoaded", () => {
  if(currentUser){
    $("storeDisplay").textContent = `Store: ${currentUser.supermarketName}`;
    loginBtn.textContent = "Edit User";
    load();
  }
});


  // SAVE INVOICE for current supermarket
  function saveInvoice(inv) {
    inv.supermarketName = currentUser.supermarketName;
    invoices.push(inv);
    localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
    renderInvoices();

  }
  
  // VALIDATE INVOICE
  function validateInvoiceForm() {
    const name = $('customerName').value.trim();
    const phone = $('customerPhone').value.trim();
    const amount = parseFloat($('amount').value)||0;
    const paid = parseFloat($('paid').value)||0;
    const formMsg = $('formMsg'); formMsg.classList.add('hidden'); formMsg.textContent='';
  
    if(!name){formMsg.textContent='Customer name required'; formMsg.classList.remove('hidden'); return false;}
    if(!phone){formMsg.textContent='Customer phone required'; formMsg.classList.remove('hidden'); return false;}
    if(amount<=0){formMsg.textContent='Total amount > 0'; formMsg.classList.remove('hidden'); return false;}
    if(paid<0){formMsg.textContent='Paid >= 0'; formMsg.classList.remove('hidden'); return false;}
    if(paid>amount){formMsg.textContent='Paid <= Total'; formMsg.classList.remove('hidden'); return false;}
    return true;
  }




 


function getTranslatedStatus(status) {
  if (status === "paid") return t("filterPaid");   // "Bixiyay" in Somali
  if (status === "unpaid") return t("filterUnpaid"); // "Bixinin" in Somali
  return status;
}

function renderInvoices() {
  const tbody = $('invoiceRows');
  tbody.innerHTML = '';

  const filter = $('filterStatus').value;
  const query = $('searchName').value.trim().toLowerCase();

  if (!Array.isArray(invoices)) return;

  const list = invoices.filter(inv => {
    if (!inv || !currentUser) return false;
    if (inv.supermarketName !== currentUser.supermarketName) return false;
    const okStatus = filter === 'all' || (inv.status || '').toLowerCase() === filter;
    const okSearch = !query || (inv.name || '').toLowerCase().includes(query) || (inv.invoiceNumber || '').toLowerCase().includes(query);
    return okStatus && okSearch;
  });

  if ($('emptyState')) {
    $('emptyState').classList.toggle('hidden', list.length !== 0);
  }

  const icons = {
    whatsapp: `<i class="fa-brands fa-whatsapp"></i>`,
    sms: `<i class="fa-solid fa-comment"></i>`,
    print: `<i class="fa-solid fa-print"></i>`,
    paid: `<i class="fa-solid fa-check"></i>`,
    unpaid: `<i class="fa-solid fa-xmark"></i>`,
    duplicate: `<i class="fa-solid fa-copy"></i>`,
    edit: `<i class="fa-solid fa-pen-to-square"></i>`,
    delete: `<i class="fa-solid fa-trash"></i>`
  };

  const lang = localStorage.getItem('lang') || 'som';
  const labels = {
    date: lang === 'som' ? 'Taariikh' : 'Date',
    customer: lang === 'som' ? 'Macmiil' : 'Customer',
    phone: lang === 'som' ? 'Telefoon' : 'Phone',
    amount: lang === 'som' ? 'Qiime' : 'Amount',
    paidLabel: lang === 'som' ? 'La bixiyay' : 'Paid',
    balanceLabel: lang === 'som' ? 'Hadhaaga' : 'Balance',
    paidBtn: lang === 'som' ? 'Bixiyay' : 'Paid',
    unpaidBtn: lang === 'som' ? 'Bixinin' : 'Unpaid'
  };

  list.forEach((inv, index) => {
    if (!inv) return;

    const status = (inv.status || 'unpaid').toLowerCase();
    const paid = inv.paid != null ? inv.paid : 0;
    const balance = inv.balance != null ? inv.balance : 0;
    const amount = inv.amount != null ? inv.amount : 0;

    const rowBg = status === 'paid'
      ? 'bg-gray-50 dark:bg-gray-700'
      : 'bg-gray-200 dark:bg-gray-600';

      const statusClasses = status === 'paid'
  ? 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-100'
  : 'bg-red-500 text-white dark:bg-red-700 dark:text-gray-100'; // red only for unpaid


    const statusText = status === 'paid' ? labels.paidBtn : labels.unpaidBtn;

    const tr = document.createElement('tr');
    tr.className = rowBg;

    tr.innerHTML = `
      <!-- Desktop columns -->
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">${index + 1}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">${inv.invoiceNumber || '-'}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">${inv.date || '-'}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">${inv.name || '-'}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">${inv.phone || '-'}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">$${fmt(amount)}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">$${fmt(paid)}</td>
      <td class="hidden sm:table-cell p-2 text-gray-800 dark:text-gray-200">$${fmt(balance)}</td>
      <td class="hidden sm:table-cell p-2">
        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs sm:text-sm font-semibold ${statusClasses}">
          ${statusText}
        </span>
      </td>
      <td class="hidden sm:table-cell p-2 no-print">
        <div class="flex flex-wrap gap-1 sm:gap-2">
          <button class="rounded-lg bg-green-600 hover:bg-green-700 text-white dark:text-gray-200 p-1 sm:p-2" onclick="sendWhatsApp(${inv.id})" title="WhatsApp">${icons.whatsapp}</button>
          <button class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white dark:text-gray-200 p-1 sm:p-2" onclick="sendSMS(${inv.id})" title="SMS">${icons.sms}</button>
          <button class="rounded-lg bg-gray-700 hover:bg-gray-800 text-white dark:text-gray-200 p-1 sm:p-2" onclick="printInvoiceById(${inv.id})" title="Print">${icons.print}</button>
          ${
            status === 'paid'
              ? `<button class="rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-900 dark:bg-gray-500 dark:text-gray-100 p-1 sm:p-2" onclick='markUnpaid(${inv.id})'>${icons.unpaid}</button>`
              : `<button class="rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:text-gray-100 p-1 sm:p-2" onclick='markPaid(${inv.id})'>${icons.paid}</button>`
          }
          <button class="rounded-lg bg-purple-600 hover:bg-purple-700 text-white dark:text-gray-200 p-1 sm:p-2" onclick="duplicateInvoice(${inv.id})">${icons.duplicate}</button>
          <button class="bg-yellow-500 text-white dark:text-gray-200 p-1 sm:p-2 rounded" onclick="editInvoice(${inv.id})">${icons.edit}</button>
          <button class="rounded-lg bg-rose-600 hover:bg-rose-700 text-white dark:text-gray-200 p-1 sm:p-2" onclick='deleteInvoice(${inv.id})'>${icons.delete}</button>
        </div>
      </td>

      <!-- Mobile card -->
      <td class="sm:hidden p-3">
        <div class="${rowBg} shadow rounded-2xl p-4 mb-3">
          <div class="flex justify-between items-center mb-2">
            <div class="text-base font-bold text-blue-600 dark:text-blue-400">#${index + 1} - ${inv.invoiceNumber || '-'}</div>
            <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold ${statusClasses}">
              ${statusText}
            </span>
          </div>
          <div class="mb-1 text-gray-800 dark:text-gray-200"><span class="font-semibold">${labels.date}:</span> ${inv.date || '-'}</div>
          <div class="mb-1 text-gray-800 dark:text-gray-200"><span class="font-semibold">${labels.customer}:</span> ${inv.name || '-'}</div>
          <div class="mb-1 text-gray-800 dark:text-gray-200"><span class="font-semibold">${labels.phone}:</span> ${inv.phone || '-'}</div>
          <div class="mb-2 text-gray-800 dark:text-gray-200">
            <span class="font-semibold">${labels.amount}:</span> $${fmt(amount)} &nbsp;
            <span class="font-semibold">${labels.paidLabel}:</span> $${fmt(paid)} &nbsp;
            <span class="font-semibold">${labels.balanceLabel}:</span> $${fmt(balance)}
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="rounded-lg bg-green-600 hover:bg-green-700 text-white dark:text-gray-200 px-3 py-2 text-sm" onclick="sendWhatsApp(${inv.id})">${icons.whatsapp}</button>
            <button class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white dark:text-gray-200 px-3 py-2 text-sm" onclick="sendSMS(${inv.id})">${icons.sms}</button>
            <button class="rounded-lg bg-gray-700 hover:bg-gray-800 text-white dark:text-gray-200 px-3 py-2 text-sm" onclick="printInvoiceById(${inv.id})">${icons.print}</button>
            ${
              status === 'paid'
                ? `<button class="rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-900 dark:bg-gray-500 dark:text-gray-100 px-3 py-2 text-sm" onclick='markUnpaid(${inv.id})'>${icons.unpaid}</button>`
                : `<button class="rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:text-gray-100 px-3 py-2 text-sm" onclick='markPaid(${inv.id})'>${icons.paid}</button>`
            }
            <button class="rounded-lg bg-purple-600 hover:bg-purple-700 text-white dark:text-gray-200 px-3 py-2 text-sm" onclick="duplicateInvoice(${inv.id})">${icons.duplicate}</button>
            <button class="bg-yellow-500 text-white dark:text-gray-200 px-3 py-2 rounded text-sm" onclick="editInvoice(${inv.id})">${icons.edit}</button>
            <button class="rounded-lg bg-rose-600 hover:bg-rose-700 text-white dark:text-gray-200 px-3 py-2 text-sm" onclick='deleteInvoice(${inv.id})'>${icons.delete}</button>
          </div>
        </div>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

// ADD ITEM ROWS + TOTAL
const itemsContainer = $('invoiceItemsContainer');
const addItemBtn = $('addItemBtn');

function t(key) {
  const currentLang = localStorage.getItem("lang") || "som";
  return translations[currentLang]?.[key] || key;
}

function addItemRow(desc = '', amt = 0) {
  const div = document.createElement('div');
  div.className = 'grid sm:grid-cols-3 gap-3 mb-2 item-row';
  div.innerHTML = `
    <input type="text" placeholder="${t('description')}" class="descInput mt-1 w-full rounded-xl border px-3 py-2" value="${desc}" />
    <input type="number" placeholder="${t('amount')}" class="amountInput mt-1 w-full rounded-xl border px-3 py-2" value="${amt}" step="0.01" />
    <button type="button" class="removeItemBtn bg-red-600 text-white px-3 py-1 rounded-xl">${t('removeItem')}</button>
  `;
  itemsContainer.appendChild(div);

  div.querySelector('.removeItemBtn').addEventListener('click', () => {
    div.remove();
    updateTotal();
  });

  div.querySelector('.amountInput').addEventListener('input', updateTotal);
}

// Update total
function updateTotal() {
  let total = 0;
  document.querySelectorAll('.amountInput').forEach(inp => {
    total += parseFloat(inp.value) || 0;
  });
  $('amount').value = total.toFixed(2);
}

// Add initial row
addItemRow();

// Add new item row button
addItemBtn.addEventListener('click', e => { 
  e.preventDefault(); 
  addItemRow(); 
});

// Update Add Item button text dynamically
addItemBtn.innerText = t("addItem");
  
  // SAVE NEW INVOICE
  $('saveInvoiceBtn').addEventListener('click', ()=> {
  if(!validateInvoiceForm()) return;

  const editingId = $('editingInvoiceId').value;

  // Collect items
  const items = [];
  document.querySelectorAll('.item-row').forEach(row => {
    const desc = row.querySelector('.descInput').value.trim();
    const amt = parseFloat(row.querySelector('.amountInput').value) || 0;
    if(desc && amt > 0) items.push({ description: desc, amount: amt });
  });

  const totalAmount = items.reduce((sum, i) => sum + i.amount, 0);
  const paid = parseFloat($('paid').value) || 0;

  if(editingId){ 
    // UPDATE EXISTING INVOICE
    const inv = invoices.find(x => x.id == editingId);
    if(!inv) return;

    inv.name = $('customerName').value.trim();
    inv.phone = $('customerPhone').value.trim();
    inv.date = $('invoiceDate').value;
    inv.items = items;
    inv.amount = totalAmount;
    inv.paid = paid;
    inv.balance = Math.max(0, totalAmount - paid);
    inv.status = $('status').value;

    alert('Invoice updated');
  } else {
    // CREATE NEW INVOICE
    const inv = {
      id: Date.now(),
      invoiceNumber: genInvoiceNumber(),
      name: $('customerName').value.trim(),
      phone: $('customerPhone').value.trim(),
      date: $('invoiceDate').value,
      items,
      amount: totalAmount,
      paid,
      balance: Math.max(0, totalAmount - paid),
      status: $('status').value,
      supermarketName: currentUser.supermarketName
    };
    invoices.push(inv);
    alert('Invoice created');
  }

  localStorage.setItem(LS_KEYS.INVOICES, JSON.stringify(invoices));
  renderInvoices();

  // Reset form
  $('createInvoiceSection').classList.add('hidden-section');
  $('editingInvoiceId').value = '';
  itemsContainer.innerHTML = '';
  addItemRow();
  clearForm();
});

  // === Edit Invoice ===
  function editInvoice(id){
  const inv = invoices.find(x => x.id === id);
  if(!inv) return;

  $('editingInvoiceId').value = inv.id;
  $('customerName').value = inv.name;
  $('customerPhone').value = inv.phone;
  $('invoiceDate').value = inv.date;
  $('amount').value = inv.amount;
  $('paid').value = inv.paid;
  $('status').value = inv.status;

  // Remove existing item rows
  itemsContainer.innerHTML = '';
  if(inv.items && inv.items.length){
    inv.items.forEach(item => addItemRow(item.description, item.amount));
  } else {
    addItemRow();
  }

  $('createInvoiceSection').classList.remove('hidden-section');
}

  // MARK PAID / UNPAID / DELETE
  function markPaid(id) {
  const i = invoices.findIndex(x => x.id === id);
  if (i === -1) return;

  // kaydi paidBefore si hadhow loo celiyo haddii unpaid la dhaho
  invoices[i].paidBefore = invoices[i].paid || 0;

  invoices[i].paid = invoices[i].amount;
  invoices[i].balance = 0;
  invoices[i].status = 'paid';

  localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
  renderInvoices();
}

function markUnpaid(id) {
  const i = invoices.findIndex(x => x.id === id);
  if (i === -1) return;

  // haddii aan hore u kaydinay paidBefore soo celi
  if (typeof invoices[i].paidBefore !== "undefined") {
    invoices[i].paid = invoices[i].paidBefore;
    invoices[i].balance = invoices[i].amount - invoices[i].paidBefore;
  } else {
    // haddii invoice cusub yahay oo aan la markPaid dhihin
    invoices[i].paid = 0;
    invoices[i].balance = invoices[i].amount;
  }

  invoices[i].status = 'unpaid';

  localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
  renderInvoices();
}

  function deleteInvoice(id) {
    if (!confirm('Delete this invoice?')) return;
    invoices = invoices.filter(x => x.id !== id);
    localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
    renderInvoices();
  }

  function clearForm() {
  $('customerName').value = '';
  $('customerPhone').value = '';
  $('invoiceDate').value = todayISO(); // sets today as default
  $('amount').value = '';
  $('paid').value = '';
  $('status').value = 'unpaid';
  $('invoiceItemsContainer').innerHTML = '';
  addItemRow(); // add one empty row
}

    // PRINT
 // Helper to escape HTML special characters
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
}

// Print invoice by invoice ID (safe for onclick)
function printInvoiceById(id) {
  const inv = invoices.find(i => i.id === id);
  if (!inv) return alert("Invoice not found");
  printInvoice(inv);
}



// Main print function
function printInvoice(inv) {
  const w = window.open('', '_blank');
  let itemsHtml = '';

  if (inv.items && inv.items.length) {
    inv.items.forEach(item => {
      itemsHtml += `<tr>
        <td>${escapeHtml(item.description)}</td>
        <td style="text-align:right;">$${fmt(item.amount)}</td>
      </tr>`;
    });
  } else {
    itemsHtml = `<tr>
      <td>Goods / Services</td>
      <td style="text-align:right;">$${fmt(inv.amount)}</td>
    </tr>`;
  }

  const html = `

<head>
  <title>Invoice ${escapeHtml(inv.invoiceNumber)}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; font-size: 14px; color: #333; }
    h2 { margin: 0; font-size: 24px; color: #1e40af; }
    .flex { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .invoice-info div { margin-bottom: 5px; font-size: 16px; }
    .bill-to { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #000; padding: 8px; }
    th { background: #f3f4f6; font-weight: bold; text-align: left; }
    td.right { text-align: right; }
    .status { display: inline-block; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    .paid { background-color: #d1fae5; color: #065f46; }
    .unpaid { background-color: #fef3c7; color: #b45309; }
    hr { border: none; border-top: 2px solid #1e40af; margin: 15px 0; }
    p { font-size: 16px; margin-top: 10px; }
  </style>
</head>
  <div class="flex">
    <div>
      <h2>${escapeHtml(currentUser.supermarketName)}</h2>
      <div>${escapeHtml(currentUser.supermarketPhone)}</div>
    </div>
    <div class="invoice-info">
      <div><strong>Invoice:</strong> ${escapeHtml(inv.invoiceNumber)}</div>
      <div><strong>Date:</strong> ${escapeHtml(inv.date)}</div>
    </div>
  </div>

  <hr>

  <div class="bill-to">
    <strong>Bill To:</strong> ${escapeHtml(inv.name)}<br>
    ${escapeHtml(inv.phone)}
  </div>

  <table>
    <thead>
      <tr><th>Description</th><th class="right">Amount</th></tr>
    </thead>
    <tbody>
      ${itemsHtml}
      <tr><td>Paid</td><td class="right">-$${fmt(inv.paid)}</td></tr>
      <tr><td><strong>Balance</strong></td><td class="right"><strong>$${fmt(inv.balance)}</strong></td></tr>
    </tbody>
  </table>

  <p>Status: <span class="status ${inv.status === 'paid' ? 'paid' : 'unpaid'}">${inv.status.toUpperCase()}</span></p>

  `;

  w.document.open();
  w.document.write(html);
  w.document.close();
  w.onload = () => setTimeout(() => { w.print(); w.close(); }, 300);
}


  // PHONE & MESSAGING
  function normalizePhone(phone) {
    phone = phone.trim();
    if (!phone.startsWith('+')) {
      phone = '+252' + phone.replace(/^0+/, '');
    }
    return phone;
  }
  
  function sendSMS(id) {
    const inv = invoices.find(x => x.id === id);
    if (!inv) return;
    const phone = normalizePhone(inv.phone);
    let message = '';
    if (inv.status === 'paid') {
  message = `Mahadsanid ${inv.name}, waxaad bixisay $${fmt(inv.paid)}.\nHadhaagagu waa: $${fmt(inv.balance)}.\nDukaanka ${currentUser.supermarketName} (${currentUser.supermarketPhone})`;
} else {
  message = `Xusuusin: ${inv.name}, lacagta lagugu leeyahay waa: $${fmt(inv.amount)}.\nFadlan iska bixi lacagta.\nDukaanka ${currentUser.supermarketName} numberka: (${currentUser.supermarketPhone})\nMahadsanid.`;
}

    window.location.href = `sms:${phone}?body=${encodeURIComponent(message)}`;
  }
  
  function sendWhatsApp(id) {
    const inv = invoices.find(x => x.id === id);
    if (!inv) return;
    const phone = normalizePhone(inv.phone);
    let message = '';
    if (inv.status === 'paid') {
  message = `Mahadsanid ${inv.name}, waxaad bixisay $${fmt(inv.paid)}.\nHadhaagagu waa: $${fmt(inv.balance)}.\nDukaanka ${currentUser.supermarketName} (${currentUser.supermarketPhone})`;
} else {
  message = `Xusuusin: ${inv.name}, lacagta lagugu leeyahay waa: $${fmt(inv.amount)}.\nFadlan iska bixi lacagta.\nDukaanka ${currentUser.supermarketName} numberka: (${currentUser.supermarketPhone})\nMahadsanid.`;
}

    window.open(`https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(message)}`, "_blank");
  }
  

// Export invoices as PDF
$('exportBtn').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const exportData = invoices.filter(inv => inv.supermarketName === currentUser.supermarketName);

  if (!exportData.length) {
    alert("No invoices to export!");
    return;
  }

  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text(`Invoices for ${currentUser.supermarketName}`, 14, 20);

  let y = 30; // starting Y position
  const pageWidth = 190; // A4 width minus margin

  // Column widths
  const colWidths = {
    no: 10,
    date: 25,
    amount: 25,
    paid: 25,
    balance: 25,
  };

  // Remaining width is for customer and phone
  const remaining = pageWidth - colWidths.no - colWidths.date - colWidths.amount - colWidths.paid - colWidths.balance - 10;
  colWidths.customer = remaining * 0.6;
  colWidths.phone = remaining * 0.4;

  const colPos = {
    no: 14,
    date: 14 + colWidths.no,
    customer: 14 + colWidths.no + colWidths.date,
    phone: 14 + colWidths.no + colWidths.date + colWidths.customer,
    amount: 14 + colWidths.no + colWidths.date + colWidths.customer + colWidths.phone,
    paid: 14 + colWidths.no + colWidths.date + colWidths.customer + colWidths.phone + colWidths.amount,
    balance: 14 + colWidths.no + colWidths.date + colWidths.customer + colWidths.phone + colWidths.amount + colWidths.paid
  };

  // Table Header
  function drawHeader(yPos) {
    doc.setFillColor(220, 220, 220);
    doc.rect(14, yPos, pageWidth, 8, 'F');
    doc.setTextColor(0);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("No", colPos.no, yPos + 6);
    doc.text("Date", colPos.date, yPos + 6);
    doc.text("Customer", colPos.customer, yPos + 6);
    doc.text("Phone", colPos.phone, yPos + 6);
    doc.text("Amount ($)", colPos.amount + colWidths.amount - 2, yPos + 6, { align: 'right' });
    doc.text("Paid ($)", colPos.paid + colWidths.paid - 2, yPos + 6, { align: 'right' });
    doc.text("Balance ($)", colPos.balance + colWidths.balance - 2, yPos + 6, { align: 'right' });
  }

  drawHeader(y);
  y += 8;

  let no = 1;
  exportData.forEach(inv => {
    if (y > 280) { // page break
      doc.addPage();
      y = 20;
      drawHeader(y);
      y += 8;
    }

    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text(`${no}`, colPos.no, y + 6); // No column in bold
    doc.setFont("helvetica", "normal");
    doc.text(`${inv.date}`, colPos.date, y + 6);

    // Wrap customer and phone
    const customerText = doc.splitTextToSize(inv.name, colWidths.customer);
    const phoneText = doc.splitTextToSize(inv.phone, colWidths.phone);
    doc.text(customerText, colPos.customer, y + 6);
    doc.text(phoneText, colPos.phone, y + 6);

    // Amounts right-aligned
    doc.text(`${inv.amount.toFixed(2)}`, colPos.amount + colWidths.amount - 2, y + 6, { align: 'right' });
    doc.text(`${inv.paid.toFixed(2)}`, colPos.paid + colWidths.paid - 2, y + 6, { align: 'right' });
    doc.text(`${inv.balance.toFixed(2)}`, colPos.balance + colWidths.balance - 2, y + 6, { align: 'right' });

    // Adjust y based on tallest wrapped column
    const maxLines = Math.max(customerText.length, phoneText.length);
    y += 8 * maxLines;
    no++;
  });

  doc.save(`invoices_${currentUser.supermarketName}.pdf`);
});

//clear paid
$('clearPaidBtn').addEventListener('click', () => {
  if(confirm("Delete all paid invoices?")) {
    invoices = invoices.filter(inv => !(inv.supermarketName === currentUser.supermarketName && inv.status === 'paid'));
    localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
    renderInvoices();
    alert("All paid invoices deleted!");
  }
});

//duplicate invoice
function duplicateInvoice(id) {
  const inv = invoices.find(x => x.id === id);
  if(!inv) return;

  const newInv = { ...inv, id: Date.now(), invoiceNumber: genInvoiceNumber(), date: todayISO() };
  invoices.push(newInv);
  localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
  renderInvoices();
  alert("Invoice duplicated!");
}

// Bulk WhatsApp/sms reminders
document.getElementById('sendAllReminders').addEventListener('click', () => {
  const unpaidInvoices = invoices.filter(
    inv => inv.supermarketName === currentUser.supermarketName && inv.status === 'unpaid'
  );

  if (unpaidInvoices.length === 0) {
    alert('No unpaid invoices to send.');
    return;
  }

  const method = document.getElementById('reminderMethod').value;

  // Group invoices by customer phone
  const invoicesByCustomer = {};
  unpaidInvoices.forEach(inv => {
    const phone = normalizePhone(inv.phone);
    if (!invoicesByCustomer[phone]) invoicesByCustomer[phone] = [];
    invoicesByCustomer[phone].push(inv);
  });

  let index = 0;
  for (const [phone, invs] of Object.entries(invoicesByCustomer)) {
    const customerName = invs[0].name || "Customer";
    const totalBalance = invs.reduce((sum, i) => sum + (i.balance || 0), 0);

    // Build a professional invoice list with emojis
    const invoiceList = invs
      .map(i => `ðŸ§¾ Invoice #${i.invoiceNumber || 'N/A'}: $${fmt(i.balance)}`)
      .join('\n');
    

    const message = `Xasuusin: ${customerName}\nWaxaa laguugu leeyahay lacagaha soo socda:\n${invoiceList}\nTotal: $${fmt(totalBalance)}\nFadlan iska bixi Dukaanka: ${currentUser.supermarketName}, Numberka ${currentUser.supermarketPhone}`;

    // Create URL
    const url = method === 'wa'
      ? `https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(message)}`
      : `sms:${phone}?body=${encodeURIComponent(message)}`;

    // Open URL in a new tab/window
    const win = window.open(url, "_blank");

    // Auto-close after a few seconds
    setTimeout(() => {
      if (win) win.close();
    }, 3000 + index * 500);

    index++;
  }

  alert(`Prepared ${Object.keys(invoicesByCustomer).length} ${method === 'wa' ? 'WhatsApp' : 'SMS'} messages for unpaid invoices.`);
});

// Somali names for days
const daysSomali = ["Axad", "Isniin", "Talaado", "Arbaco", "Khamiis", "Jimco", "Sabti"];

// Function to get day name in Somali or English
function getDayName(date, lang = "som") {
  const dayIndex = date.getDay(); // 0 = Sunday, 1 = Monday, ...
  if(lang === "som") return daysSomali[dayIndex];
  return date.toLocaleDateString("en-US", { weekday: "long" });
}


function updateClock() {
  const timeEl = document.getElementById("currentTime");
  const now = new Date();
  const lang = localStorage.getItem("lang") || "som";

  // Somali day names
  const daysSomali = ["Axad", "Isniin", "Talaado", "Arbaco", "Khamiis", "Jimco", "Sabti"];
  
  let weekday = now.toLocaleString('en-US', { weekday: 'long' }); // Default English
  if (lang === "som") {
    weekday = daysSomali[now.getDay()]; // Replace with Somali
  }

  // Format time and date
  const options = { 
    year: 'numeric', 
    month: 'numeric', 
    day: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit',
    hour12: true
  };
  const dateTime = now.toLocaleString('en-US', options);

  // Display with day name
  timeEl.textContent = `${weekday}, ${dateTime}`;
}

// Update clock immediately and every second
updateClock();
setInterval(updateClock, 1000);


// Live search and status filter
$('filterStatus').addEventListener('change', renderInvoices);
$('searchName').addEventListener('input', renderInvoices);


load();

  </script>
</body>
</html>
