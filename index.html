<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Maker â€“ Step 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { .no-print { display: none !important; } }
    .hidden-section { display: none; }
    .modal-bg { display: none; background: rgba(0,0,0,0.5); position: fixed; inset: 0; justify-content: center; align-items: center; z-index: 50; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">

    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-bold">ðŸ§¾ Invoice Maker</h1>
      <div class="flex gap-2 items-center">
        <button id="loginSupermarketBtn" class="rounded-xl bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 no-print">
          Login / Setup Supermarket
        </button>
        <span id="storeDisplay" class="font-semibold text-gray-700"></span>
      </div>
    </header>

    <!-- MODAL FOR SUPERMARKET -->
    <div id="supermarketModal" class="modal-bg flex hidden">
      <div class="bg-white rounded-2xl p-6 w-96">
        <h2 class="text-lg font-semibold mb-3">Supermarket Info</h2>
        <div class="grid gap-3">
          <input id="modalStoreName" class="border rounded-xl px-3 py-2" placeholder="Supermarket Name" />
          <input id="modalStorePhone" class="border rounded-xl px-3 py-2" placeholder="Phone" />
          <input id="modalStoreLocation" class="border rounded-xl px-3 py-2" placeholder="Location" />
          <input id="modalStoreEmail" class="border rounded-xl px-3 py-2" placeholder="Email" />
          <div class="flex justify-end gap-2 mt-3">
            <button id="closeModalBtn" class="px-4 py-2 rounded-xl bg-gray-400 hover:bg-gray-500 text-white">Cancel</button>
            <button id="saveModalBtn" class="px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE INVOICE BUTTON -->
    <div class="mb-4">
      <button id="showCreateInvoiceBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 no-print">
        Create Invoice
      </button>
    </div>

    <!-- CREATE INVOICE FORM -->
    <section id="createInvoiceSection" class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6 hidden-section">
      <h2 class="text-lg font-semibold mb-3">Create Invoice</h2>
    
      <!-- Customer Info -->
      <div class="grid sm:grid-cols-5 gap-3 mb-4">
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Name</span>
          <input id="customerName" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. Ali Mohamed" />
        </label>
        <label class="block sm:col-span-2">
          <span class="text-sm">Customer Phone</span>
          <input id="customerPhone" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g. 617XXXXXX" />
        </label>
        <label class="block">
          <span class="text-sm">Invoice Date</span>
          <input id="invoiceDate" type="date" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </label>
      </div>
    
      <!-- Invoice Items -->
      <div id="invoiceItemsContainer" class="mb-3">
        <!-- Item rows will appear here -->
      </div>
      <button id="addItemBtn" class="mb-3 inline-block rounded-xl bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">+ Add Item</button>
    
      <div class="grid sm:grid-cols-2 gap-3 mb-3">
        <label>
          <span class="text-sm">Total Amount</span>
          <input id="amount" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" readonly />
        </label>
        <label>
          <span class="text-sm">Amount Paid</span>
          <input id="paid" type="number" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="0" />
        </label>
        <label>
          <span class="text-sm">Status</span>
          <select id="status" class="mt-1 w-full rounded-xl border px-3 py-2">
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
        </label>
      </div>
    
      <button id="saveInvoiceBtn" class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700 w-full">Save Invoice</button>
      <p id="formMsg" class="hidden mt-3 text-red-600 text-sm"></p>
    </section>
    

    <!-- INVOICES LIST -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Invoices</h2>
        <div class="flex gap-2 no-print">
          <select id="filterStatus" class="rounded-xl border px-3 py-2">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
          <input id="searchName" class="rounded-xl border px-3 py-2" placeholder="Search by name..." />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full min-w-[600px] border-collapse">
          <thead>
            <tr>
              <th class="p-2 border">Invoice</th>
              <th class="p-2 border">Date</th>
              <th class="p-2 border">Customer</th>
              <th class="p-2 border">Phone</th>
              <th class="p-2 border">Amount</th>
              <th class="p-2 border">Paid</th>
              <th class="p-2 border">Balance</th>
              <th class="p-2 border">Status</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody id="invoiceRows"></tbody>
        </table>
      </div>
      

      <p id="emptyState" class="hidden text-center text-gray-500 py-6">No invoices yet.</p>
    </section>
  </div>

  <script>
    const LS_KEYS = { SETTINGS: 'invoice_settings_v1', INVOICES: 'invoices_v1' };
    let settings = { storeName:'', storePhone:'', storeLocation:'', storeEmail:'' };
    let invoices = [];

    const $ = id => document.getElementById(id);
    const fmt = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const todayISO = () => new Date().toISOString().slice(0,10);
    const genInvoiceNumber = () => {
      const d = new Date(); const pad = x=>String(x).padStart(2,'0');
      return `INV-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.floor(Math.random()*1000)}`;
    };

    function load() {
      const s = localStorage.getItem(LS_KEYS.SETTINGS);
      if (s) settings = JSON.parse(s);
      $('storeDisplay').textContent = settings.storeName ? `Store: ${settings.storeName}` : '';
      invoices = JSON.parse(localStorage.getItem(LS_KEYS.INVOICES)||'[]');
      $('invoiceDate').value = todayISO();
      renderInvoices();
    }

    // MODAL LOGIC
    const loginBtn = $('loginSupermarketBtn'), modal = $('supermarketModal'),
          closeModalBtn = $('closeModalBtn'), saveModalBtn = $('saveModalBtn');
    loginBtn.addEventListener('click', ()=>{
      modal.classList.remove('hidden'); modal.classList.add('flex');
      $('modalStoreName').value = settings.storeName || '';
      $('modalStorePhone').value = settings.storePhone || '';
      $('modalStoreLocation').value = settings.storeLocation || '';
      $('modalStoreEmail').value = settings.storeEmail || '';
    });
    closeModalBtn.addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); });
    saveModalBtn.addEventListener('click', ()=>{
      settings.storeName = $('modalStoreName').value.trim();
      settings.storePhone = $('modalStorePhone').value.trim();
      settings.storeLocation = $('modalStoreLocation').value.trim();
      settings.storeEmail = $('modalStoreEmail').value.trim();
      localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(settings));
      modal.classList.add('hidden'); modal.classList.remove('flex');
      $('storeDisplay').textContent = settings.storeName ? `Store: ${settings.storeName}` : '';
      alert(`Supermarket info saved: ${settings.storeName}`);
    });

    // SHOW/HIDE CREATE INVOICE
    const createBtn = $('showCreateInvoiceBtn'), createSection = $('createInvoiceSection');
    createBtn.addEventListener('click', ()=>{ createSection.classList.toggle('hidden-section'); });

    // FORM VALIDATION
    function validateInvoiceForm() {
      const name = $('customerName').value.trim();
      const phone = $('customerPhone').value.trim();
      const amount = parseFloat($('amount').value)||0;
      const paid = parseFloat($('paid').value)||0;
      const formMsg = $('formMsg'); formMsg.classList.add('hidden'); formMsg.textContent='';
      if(!name){formMsg.textContent='Customer name required'; formMsg.classList.remove('hidden'); return false;}
      if(!phone){formMsg.textContent='Customer phone required'; formMsg.classList.remove('hidden'); return false;}
      if(amount<=0){formMsg.textContent='Total amount > 0'; formMsg.classList.remove('hidden'); return false;}
      if(paid<0){formMsg.textContent='Paid >= 0'; formMsg.classList.remove('hidden'); return false;}
      if(paid>amount){formMsg.textContent='Paid <= Total'; formMsg.classList.remove('hidden'); return false;}
      if(!settings.storeName || !settings.storePhone){formMsg.textContent='Save supermarket info first'; formMsg.classList.remove('hidden'); return false;}
      return true;
    }


    const itemsContainer = $('invoiceItemsContainer');
const addItemBtn = $('addItemBtn');

// Function to add a new item row
function addItemRow(desc = '', amt = 0) {
  const div = document.createElement('div');
  div.className = 'grid sm:grid-cols-3 gap-3 mb-2 item-row';
  div.innerHTML = `
    <input type="text" placeholder="Description" class="descInput mt-1 w-full rounded-xl border px-3 py-2" value="${desc}" />
    <input type="number" placeholder="Amount" class="amountInput mt-1 w-full rounded-xl border px-3 py-2" value="${amt}" step="0.01" />
    <button type="button" class="removeItemBtn bg-red-600 text-white px-3 py-1 rounded-xl">Remove</button>
  `;
  itemsContainer.appendChild(div);

  div.querySelector('.removeItemBtn').addEventListener('click', () => {
    div.remove();
    updateTotal();
  });

  div.querySelector('.amountInput').addEventListener('input', updateTotal);
}

// Calculate total amount
function updateTotal() {
  let total = 0;
  document.querySelectorAll('.amountInput').forEach(inp => {
    const val = parseFloat(inp.value) || 0;
    total += val;
  });
  $('amount').value = total.toFixed(2);
}

// Add initial empty row
addItemRow();

// Add new item row on button click
addItemBtn.addEventListener('click', (e) => {
  e.preventDefault();
  addItemRow();
});


$('saveInvoiceBtn').addEventListener('click', ()=> {
  if(!validateInvoiceForm()) return;

  // Collect items
  const items = [];
  document.querySelectorAll('.item-row').forEach(row => {
    const desc = row.querySelector('.descInput').value.trim();
    const amt = parseFloat(row.querySelector('.amountInput').value) || 0;
    if(desc && amt > 0) items.push({ description: desc, amount: amt });
  });

  const totalAmount = items.reduce((sum, i) => sum + i.amount, 0);
  const paid = parseFloat($('paid').value) || 0;

  const inv = {
    id: Date.now(),
    invoiceNumber: genInvoiceNumber(),
    name: $('customerName').value.trim(),
    phone: $('customerPhone').value.trim(),
    date: $('invoiceDate').value,
    items,
    amount: totalAmount,
    paid,
    balance: Math.max(0, totalAmount - paid),
    status: $('status').value
  };

  invoices.push(inv);
  localStorage.setItem(LS_KEYS.INVOICES, JSON.stringify(invoices));
  renderInvoices();

  // Reset form
  createSection.classList.add('hidden-section');
  itemsContainer.innerHTML = '';
  addItemRow();
  $('customerName').value = '';
  $('customerPhone').value = '';
  $('invoiceDate').value = '';
  $('amount').value = '';
  $('paid').value = '';
  $('status').value = 'unpaid';
  alert('Invoice created');
});

function clearForm() {
  $('customerName').value = '';
  $('customerPhone').value = '';
  $('amount').value = '';
  $('paid').value = '';
  $('status').value = 'unpaid';
  $('invoiceDate').value = todayISO();
}

    // RENDER INVOICES
    function renderInvoices(){
      const tbody = $('invoiceRows'); tbody.innerHTML='';
      const filter = $('filterStatus').value; const query = $('searchName').value.trim().toLowerCase();
      const list = invoices.filter(inv=>{
        const okStatus = filter==='all'||inv.status===filter;
        const okSearch = !query || inv.name.toLowerCase().includes(query) || inv.invoiceNumber.toLowerCase().includes(query);
        return okStatus && okSearch;
      });
      $('emptyState').classList.toggle('hidden', list.length!==0);
      list.forEach(inv=>{
        const tr = document.createElement('tr');
        tr.className = inv.status==='unpaid'&&inv.balance>0?'bg-red-50':'';
        tr.innerHTML=`
          <td class="p-2 font-medium">${inv.invoiceNumber}</td>
          <td class="p-2">${inv.date}</td>
          <td class="p-2">${inv.name}</td>
          <td class="p-2">${inv.phone}</td>
          <td class="p-2">$${fmt(inv.amount)}</td>
          <td class="p-2">$${fmt(inv.paid)}</td>
          <td class="p-2">$${fmt(inv.balance)}</td>
          <td class="p-2">
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ${inv.status==='paid'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'}">
              ${inv.status.toUpperCase()}
            </span>
          </td>
       <td class="p-2 no-print">
  <div class="flex flex-wrap gap-2">
    <button class="rounded-lg bg-green-600 hover:bg-green-700 text-white px-3 py-1" onclick="sendWhatsApp(${inv.id})">WhatsApp</button>
    <button class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white px-3 py-1" onclick="sendSMS(${inv.id})">SMS</button>
    <button class="rounded-lg bg-gray-700 hover:bg-gray-800 text-white px-3 py-1" onclick='printInvoice(${JSON.stringify(inv)})'>Print</button>
    ${inv.status === 'paid' 
      ? `<button class="rounded-lg bg-amber-600 hover:bg-amber-700 text-white px-3 py-1" onclick='markUnpaid(${inv.id})'>Mark Unpaid</button>`
      : `<button class="rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1" onclick='markPaid(${inv.id})'>Mark Paid</button>`
    }
    <button class="rounded-lg bg-rose-600 hover:bg-rose-700 text-white px-3 py-1" onclick='deleteInvoice(${inv.id})'>Delete</button>
  </div>
</td>

        `;
        tbody.appendChild(tr);
      });
    }

    // MARK PAID / UNPAID / DELETE
    function markPaid(id) {
  const i = invoices.findIndex(x => x.id === id);
  if (i === -1) return;

  // Save original paid value if not already saved
  if (invoices[i].originalPaid === undefined) {
    invoices[i].originalPaid = invoices[i].paid;
  }

  invoices[i].paid = invoices[i].amount;
  invoices[i].balance = 0;
  invoices[i].status = 'paid';

  localStorage.setItem(LS_KEYS.INVOICES, JSON.stringify(invoices));
  renderInvoices();
}

function markUnpaid(id) {
  const i = invoices.findIndex(x => x.id === id);
  if (i === -1) return;

  // Restore paid amount from originalPaid if available
  invoices[i].paid = invoices[i].originalPaid !== undefined ? invoices[i].originalPaid : invoices[i].paid;
  invoices[i].balance = Math.max(0, invoices[i].amount - invoices[i].paid);
  invoices[i].status = 'unpaid';

  localStorage.setItem(LS_KEYS.INVOICES, JSON.stringify(invoices));
  renderInvoices();
}

function deleteInvoice(id) {
  if (!confirm('Delete this invoice?')) return;
  invoices = invoices.filter(x => x.id !== id);
  localStorage.setItem(LS_KEYS.INVOICES, JSON.stringify(invoices));
  renderInvoices();
}

    // PRINT
    function printInvoice(inv) {
  const w = window.open('', '_blank');

  // Build rows for each item
  let itemsHtml = '';
  if (inv.items && inv.items.length) {
    inv.items.forEach(item => {
      itemsHtml += `<tr><td>${item.description}</td><td class="right">$${fmt(item.amount)}</td></tr>`;
    });
  } else {
    // fallback if no items
    itemsHtml = `<tr><td>Goods / Services</td><td class="right">$${fmt(inv.amount)}</td></tr>`;
  }

  const html = `
    
        <div class='row'>
          <div>
            <h2 style="margin:0">${settings.storeName}</h2>
            <div class='muted'>${settings.storePhone}</div>
          </div>
          <div class='right'>
            <div><strong>Invoice:</strong> ${inv.invoiceNumber}</div>
            <div><strong>Date:</strong> ${inv.date}</div>
          </div>
        </div>
        <hr style="margin:16px 0">
        <div>
          <div><strong>Bill To:</strong> ${inv.name}</div>
          <div class='muted'>${inv.phone}</div>
        </div>
        <table>
          <thead><tr><th>Description</th><th class='right'>Amount</th></tr></thead>
          <tbody>
            ${itemsHtml}
            <tr><td>Paid</td><td class='right'>-$${fmt(inv.paid)}</td></tr>
            <tr><td><strong>Balance</strong></td><td class='right'><strong>$${fmt(inv.balance)}</strong></td></tr>
          </tbody>
        </table>
        <p class='muted'>Status: ${inv.status ? inv.status.toUpperCase() : 'UNPAID'}</p>
   
  `;

  w.document.open();
  w.document.write(html);
  w.document.close();

  // Print after content is loaded
  w.onload = () => { setTimeout(() => { w.print(); w.close(); }, 300); };
}

    // PLACEHOLDER
    function normalizePhone(phone) {
  phone = phone.trim();
  // If phone already starts with '+', use as-is
  if (!phone.startsWith('+')) {
    phone = '+252' + phone.replace(/^0+/, ''); // remove leading zeros and add +252
  }
  return phone;
}


function sendSMS(id) { 
  const inv = invoices.find(x => x.id === id);
  if (!inv) return;

  const settings = JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS)) || {};
  const shopName = settings.storeName || "My Supermarket";
  const shopPhone = settings.storePhone || "000000000";

  const phone = normalizePhone(inv.phone);

  let message = "";

  if (inv.status === "paid") {
     message = `Mahadsanid ${inv.name}, waxaad bixisay $${fmt(inv.paid)}.
Hadhaagaaga: $${fmt(inv.balance)}.
Supermarket: ${shopName} (${shopPhone})`;
} else {
  message = `Xusuusin: ${inv.name}, lacagta lagugu leeyahay waa $${fmt(inv.amount)}.
Fadlan iska bixi lacagta supermarket-ka ${shopName} oo leh Number: ${shopPhone}.
Mahadsanid.`;
  }

  window.location.href = `sms:${phone}?body=${encodeURIComponent(message)}`;
}

function sendWhatsApp(id) {
  const inv = invoices.find(x => x.id === id);
  if (!inv) return;

  const settings = JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS)) || {};
  const shopName = settings.storeName || "My Supermarket";
  const shopPhone = settings.storePhone || "000000000";

  const phone = normalizePhone(inv.phone);

  let message = "";

  if (inv.status === "paid") {
      message = `Mahadsanid ${inv.name}, waxaad bixisay $${fmt(inv.paid)}.
Hadhaagaaga: $${fmt(inv.balance)}.
Supermarket: ${shopName} (${shopPhone})`;
} else {
  message = `Xusuusin: ${inv.name}, lacagta lagugu leeyahay waa $${fmt(inv.amount)}.
Fadlan iska bixi lacagta supermarket-ka ${shopName} oo leh Number: ${shopPhone}.
Mahadsanid.`;
}


  window.open(`https://wa.me/${phone.replace('+','')}` + `?text=${encodeURIComponent(message)}`, "_blank");
}


    // FILTER & SEARCH
    $('filterStatus').addEventListener('change', renderInvoices);
    $('searchName').addEventListener('input', renderInvoices);

    load();


    function createMessage(inv) {
  const name = inv.name;
  const amount = Number(inv.amount || 0);
  const paid = Number(inv.paid || 0);
  const balance = Math.max(0, amount - paid);
  if (inv.status === 'paid' && balance === 0) {
    return `Thank you ${name}, you have paid $${fmt(paid)}.\nBalance: $${fmt(balance)}.\nFrom: ${settings.storeName} (${settings.storePhone})`;
  } else {
    // Reminder shows amount due (remaining)
    const due = balance > 0 ? balance : amount;
    return `Reminder: Dear ${name}, your invoice amount is $${fmt(due)}.\nPlease pay at ${settings.storeName} (${settings.storePhone}).\nThank you.`;
  }
}

function openWhatsApp(phone, text) {
  // wa.me requires MSISDN without +, e.g., 25261XXXXXXX
  const clean = String(phone).replace(/[^0-9]/g, '');
  const url = `https://wa.me/${clean}?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
}

function openSMS(phone, text) {
  // sms: scheme â€“ works on phones (may not on desktop)
  // Some platforms use ?body=, others &body=
  const clean = String(phone).replace(/[^0-9+]/g, '');
  const url = `sms:${clean}?body=${encodeURIComponent(text)}`;
  // Using location.href increases chance of opening native app
  window.location.href = url;
}
  </script>
</body>
</html>


